{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<!-- Título principal con espacio superior reducido y en mayúsculas -->
<h1 style="text-align: center; font-weight: bold; margin-top: 0.1rem; margin-bottom: 20px; color: #333; font-size: 1.3rem; text-transform: uppercase;">Consultar Ficha Médica</h1>

<!-- CSRF Token para AJAX -->
{% csrf_token %}

<!-- Botones para seleccionar mascota y nueva búsqueda -->
<div style="width: 80%; margin-left: auto; margin-right: auto; display: flex; justify-content: flex-end; gap: 15px; margin-bottom: 20px;">
    <button type="button" id="btnSeleccionarMascota" class="btn btn-primary" onclick="abrirModalSeleccionarMascota()" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
        <i class="fas fa-search"></i> Seleccionar Mascota
    </button>
    {% if mascota_encontrada %}
    <button type="button" class="btn btn-success" onclick="realizarNuevaBusqueda()" style="background-color: #28a745; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
        <i class="fas fa-refresh"></i> Realizar Nueva Búsqueda
    </button>
    {% endif %}
</div>

{% if mascota_encontrada %}
    <!-- Título "Antecedentes del Tutor(a)" movido fuera del contenedor -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto;">ANTECEDENTES DEL TUTOR(A)</h5>
    
    <!-- Bloque "Antecedentes del Tutor/a" con el mismo estilo visual -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">RUT</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.nro_documento }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div></div>
                <div></div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Nombres</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.nombres }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Paterno</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.apellido_paterno }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Materno</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.apellido_materno|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Correo</label>
                    <input type="email" value="{{ mascota_encontrada.id_tutor.email|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Celular</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.celular|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div></div>
            </div>
        </div>
    </div>
    
    <!-- Título "Datos de la Mascota" -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto; margin-top: 20px;">DATOS DE LA MASCOTA</h5>
    
    <!-- Bloque "Datos de la Mascota" -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px;">
            <!-- Primera fila: Microchip, Nombre, Especie -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Microchip</label>
                    <input type="text" value="{{ mascota_encontrada.nro_chip }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Nombre</label>
                    <input type="text" value="{{ mascota_encontrada.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Especie</label>
                    <input type="text" value="{{ mascota_encontrada.id_especie.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
            
            <!-- Segunda fila: Raza, Color, Patrón -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Raza</label>
                    <input type="text" value="{{ mascota_encontrada.id_raza.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Color</label>
                    <input type="text" value="{{ mascota_encontrada.color|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Patrón</label>
                    <input type="text" value="{{ mascota_encontrada.patron|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
            
            <!-- Tercera fila: Fecha de Nacimiento, Sexo, Esterilizado -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Fecha de Nacimiento</label>
                    <input type="text" value="{{ mascota_encontrada.fecha_nacimiento|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Sexo</label>
                    <input type="text" value="{{ mascota_encontrada.sexo|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Esterilizado</label>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="esterilizado_{{ mascota_encontrada.id_mascota }}" value="si" {% if mascota_encontrada.estado_reproductivo == True %}checked{% endif %} disabled style="margin: 0;">
                            <span style="font-size: 0.65rem; color: #333;">Sí</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="esterilizado_{{ mascota_encontrada.id_mascota }}" value="no" {% if mascota_encontrada.estado_reproductivo == False %}checked{% endif %} disabled style="margin: 0;">
                            <span style="font-size: 0.65rem; color: #333;">No</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cuarta fila: Modo de Obtención, Razón de Tenencia, Estado Vital -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Modo de Obtención</label>
                    <input type="text" value="{{ mascota_encontrada.modo_obtencion|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Razón de Tenencia</label>
                    <input type="text" value="{{ mascota_encontrada.razon_tenencia|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Estado Vital</label>
                    <input type="text" value="{{ mascota_encontrada.estado_vital|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
            
            <!-- Quinta fila: Notas Adicionales -->
            <div style="margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Notas Adicionales</label>
                    <textarea readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem; min-height: 60px; resize: vertical;">{{ mascota_encontrada.notas_adicionales|default:'' }}</textarea>
                </div>
            </div>

        </div>
    </div>
    
         <!-- Título "Autorización para compartir antecedentes médicos" -->
     <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto; margin-top: 20px;">AUTORIZACIÓN PARA COMPARTIR ANTECEDENTES MÉDICOS</h5>
    
    <!-- Bloque "Autorización para compartir datos" -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px;">
            <!-- Primera fila: Registra consentimiento de interoperabilidad y enlace -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div style="grid-column: span 2;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="font-weight: bold; color: #666; font-size: 0.65rem; margin: 0; white-space: nowrap;">Registra consentimiento de interoperabilidad?</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="consentimiento_{{ mascota_encontrada.id_mascota }}" value="si" {% if mascota_encontrada.consentimiento %}checked{% endif %} disabled style="margin: 0;">
                                <span style="font-size: 0.65rem; color: #333;">Sí</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="consentimiento_{{ mascota_encontrada.id_mascota }}" value="no" {% if not mascota_encontrada.consentimiento %}checked{% endif %} disabled style="margin: 0;">
                                <span style="font-size: 0.65rem; color: #333;">No</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: end;">
                    <button type="button" id="consentimiento-link-{{ mascota_encontrada.id_mascota }}" 
                            onclick="manejarConsentimiento({{ mascota_encontrada.id_mascota }})" 
                            class="btn btn-sm" 
                            style="background-color: #e6a700; color: #FFFFFF; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; white-space: nowrap; text-decoration: none; display: inline-block; cursor: pointer;">
                        {% if mascota_encontrada.consentimiento %}
                            Visualizar Documento
                        {% else %}
                            Adjuntar Documento de Consentimiento
                        {% endif %}
                    </button>
                </div>
            </div>
            
                         <!-- Segunda fila: Clínica donde firma el consentimiento -->
             <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 10px;">
                 <div style="grid-column: span 2;">
                     <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Clínica donde firma el consentimiento</label>
                     <input type="text" value="{{ mascota_encontrada.id_clinica_consentimiento.nombre|default:'No especificada' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                 </div>
                 <div>
                     <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Fecha de consentimiento</label>
                     <input type="text" value="{{ mascota_encontrada.fecha_consentimiento|default:'No registrada' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                 </div>
             </div>
             
             <!-- Texto informativo -->
             <div style="margin-top: 15px; padding: 10px 15px; background-color: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
                 <p style="margin: 0; color: #0056b3; font-size: 0.65rem; font-style: italic; line-height: 1.4;">
                     <strong>Recuerde:</strong> la autorización para compartir la información de las consultas médicas de los pacientes estará disponible únicamente para las clínicas registradas en la plataforma VetLink.
                 </p>
             </div>
        </div>
    </div>
    
    <!-- Título "Historial de Atenciones Médicas" -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto; margin-top: 20px;">HISTORIAL DE ATENCIONES MÉDICAS</h5>
    
    {% if historial_atenciones %}
        <!-- Tabla de Historial de Atenciones con ancho ajustado al 80% -->
        <div style="width: 80%; margin-left: auto; margin-right: auto;">
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; background-color: #fff;">
                <thead style="background-color: #f8f9fa;">
                    <tr>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: center;">Fecha</th>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: left;">Clínica</th>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: left;">Servicio</th>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: left;">Detalle del Servicio</th>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: left;">Veterinario</th>
                        <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.65rem; text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for atencion in historial_atenciones %}
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem; text-align: center;">{{ atencion.fecha_atencion|date:"d/m/Y" }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">{{ atencion.id_clinica.nombre|default:"" }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">{{ atencion.id_servicio_detalle.id_servicio.nombre|default:"" }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">{{ atencion.id_servicio_detalle.nombre|default:"" }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">{{ atencion.id_personal.nombres|default:"" }} {{ atencion.id_personal.apellido_paterno|default:"" }}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle;">
                            <a href="/mascotas/atencion-detalle/{{ atencion.id_atencion }}/" class="btn btn-sm" style="background-color: #e6a700; color: #FFFFFF; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; white-space: nowrap; text-decoration: none; display: inline-block;">
                                Ver Detalle
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Botón "Registrar Nueva Atención" centrado -->
        <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="registrarNuevaAtencion()" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                <i class="fas fa-stethoscope"></i> Registrar Nueva Atención
            </button>
        </div>
    {% else %}
        <p style="color: #666; margin-bottom: 30px; font-size: 0.65rem; width: 80%; margin-left: auto; margin-right: auto; text-align: center;">No hay atenciones médicas registradas para esta mascota.</p>
        
        <!-- Botón "Registrar Nueva Atención" centrado -->
        <div style="text-align: center; margin-top: 1.5rem;">
            <button class="btn btn-primary" onclick="registrarNuevaAtencion()" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                <i class="fas fa-stethoscope"></i> Registrar Nueva Atención
            </button>
        </div>
    {% endif %}
    
{% elif mensaje %}
    <div class="alert alert-warning mt-4" style="background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin: 0 auto; width: 80%; text-align: center;">
        {{ mensaje }}
    </div>
{% endif %}

<!-- Modal para ver documento de consentimiento -->
<div id="modalVerConsentimiento" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 600px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; position: relative;">
            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-file-alt"></i> Documento de Consentimiento
            </h3>
            <button type="button" onclick="cerrarModalVerConsentimiento()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
            <div id="contenidoModalVer">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #007bff; margin-bottom: 15px;"></i>
                    <p style="color: #666; font-size: 1rem; margin: 0;">Cargando documento...</p>
                </div>
            </div>
        </div>
                 <div class="modal-footer" style="padding: 20px 25px; border-top: 1px solid #e9ecef; text-align: right; background-color: #f8f9fa; position: relative;">
             <button type="button" class="btn btn-secondary" onclick="cerrarModalVerConsentimiento()" style="background-color: #6c757d; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                 <i class="fas fa-times"></i> Cerrar
             </button>
         </div>
    </div>
</div>

<!-- Modal para subir documento de consentimiento -->
<div id="modalSubirConsentimiento" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 500px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; position: relative;">
            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-upload"></i> Subir Documento de Consentimiento
            </h3>
            <button type="button" onclick="cerrarModalSubirConsentimiento()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>
        </div>
                 <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
             <form id="formSubirConsentimiento" enctype="multipart/form-data">
                 <!-- Texto explicativo -->
                 <div style="background-color: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                     <p style="margin: 0; color: #0056b3; font-size: 0.8rem; line-height: 1.4; font-style: italic;">
                         <strong>Recuerde informar al tutor que este consentimiento autoriza compartir todos los antecedentes médicos de su mascota para cualquier atención que reciba, tanto en esta clínica como en cualquier otra que forme parte de la plataforma VetLink.</strong>
                     </p>
                 </div>
                 
                 <div style="margin-bottom: 20px;">
                     <label style="display: block; font-weight: bold; color: #333; font-size: 0.9rem; margin-bottom: 8px;">Seleccionar archivo:</label>
                     <input type="file" id="archivoConsentimiento" name="documento" accept=".pdf,.jpg,.jpeg,.png" required 
                            style="width: 100%; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; background-color: #f8f9fa; cursor: pointer;">
                     <small style="color: #666; font-size: 0.75rem; margin-top: 5px; display: block;">
                         Formatos permitidos: PDF, JPG, JPEG, PNG. Tamaño máximo: 10MB
                     </small>
                 </div>
                 <div id="errorSubida" style="display: none; background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.8rem;"></div>
                 <div id="progresoSubida" style="display: none; text-align: center; padding: 15px;">
                     <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem; color: #007bff; margin-bottom: 10px;"></i>
                     <p style="color: #666; font-size: 0.9rem; margin: 0;">Subiendo documento...</p>
                 </div>
             </form>
         </div>
        <div class="modal-footer" style="padding: 20px 25px; border-top: 1px solid #e9ecef; text-align: right; background-color: #f8f9fa; position: relative;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModalSubirConsentimiento()" style="background-color: #6c757d; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px; margin-right: 10px;">
                <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="button" class="btn btn-primary" onclick="subirConsentimiento()" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px;">
                <i class="fas fa-save"></i> Guardar
            </button>
        </div>
    </div>
</div>

<!-- Modal para seleccionar mascota -->
<div id="modalSeleccionarMascota" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; position: relative;">
            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-paw"></i> Seleccionar Mascota
            </h3>
            <button type="button" onclick="cerrarModalSeleccionarMascota()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
            <!-- Formulario de búsqueda por RUT -->
            <div style="margin-bottom: 20px;">
                <form id="formBuscarTutor" style="display: flex; align-items: end;">
                    <div style="margin-right: 10px;">
                        <label style="display: block; font-weight: bold; color: #333; font-size: 0.9rem; margin-bottom: 8px;">Ingrese el Rut del Tutor(a):</label>
                        <input type="text" id="rutTutor" name="rut_tutor" placeholder="Ej: 12345678-9" required 
                               style="width: 200px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; box-sizing: border-box;">
                    </div>
                    <div>
                        <button type="button" onclick="buscarMascotasPorTutor()" class="btn btn-primary" 
                                style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer; white-space: nowrap;">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Área de resultados -->
            <div id="resultadosMascotas" style="display: none;">
                <h4 style="color: #333; margin-bottom: 15px; font-size: 1rem;">Mascotas encontradas:</h4>
                <div style="overflow-x: auto;">
                    <table id="tablaMascotas" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; background-color: #fff;">
                        <thead style="background-color: #f8f9fa;">
                            <tr>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Microchip</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Nombre</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Especie</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Sexo</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Estado</th>
                                <th style="padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyMascotas">
                            <!-- Los resultados se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Mensaje de error -->
            <div id="mensajeError" style="display: none; background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin-top: 15px; font-size: 0.9rem;"></div>
            
            <!-- Loading -->
            <div id="loadingBusqueda" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #007bff; margin-bottom: 15px;"></i>
                <p style="color: #666; font-size: 1rem; margin: 0;">Buscando mascotas...</p>
            </div>
        </div>
        <div class="modal-footer" style="padding: 20px 25px; border-top: 1px solid #e9ecef; text-align: right; background-color: #f8f9fa; position: relative;">
            <button type="button" class="btn btn-secondary" onclick="cerrarModalSeleccionarMascota()" style="background-color: #6c757d; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                <i class="fas fa-times"></i> Cerrar
            </button>
        </div>
    </div>
</div>

<style>
    /* Estilos adicionales para mejorar la apariencia */
    .container {
        font-family: Arial, sans-serif;
    }
    
    /* Estilo para el campo de entrada del formulario */
    input[type="text"], input[type="email"] {
        border-radius: 5px;
        border: 1px solid #ddd;
        padding: 8px 12px;
        font-size: 12px;
        box-sizing: border-box;
        max-width: 300px; /* Tamaño para campo de chip */
    }
    
    input[type="text"]:focus, input[type="email"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    /* Estilo para campos de solo lectura */
    input[readonly] {
        background-color: #f8f9fa !important;
        color: #333 !important;
        cursor: not-allowed;
    }
    
    /* Mejoras en la tabla */
    .table th {
        font-weight: bold;
        color: #333;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    /* Estilo para el botón Buscar */
    .btn {
        transition: all 0.2s ease-in-out;
    }
    
         .btn:hover {
         transform: translateY(-1px);
         box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }
     
     /* Estilo para botón deshabilitado */
     .btn:disabled {
         opacity: 0.6 !important;
         cursor: not-allowed !important;
         transform: none !important;
         box-shadow: none !important;
     }
    

     
     /* Animación para el modal */
     @keyframes modalFadeIn {
         from {
             opacity: 0;
             transform: translateY(-50px) scale(0.9);
         }
         to {
             opacity: 1;
             transform: translateY(0) scale(1);
         }
     }
     
     .modal {
         animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
     }
     
     /* Estilos para el preview de documentos */
     .documento-preview {
         text-align: center;
         padding: 20px;
     }
     
     .documento-preview img {
         max-width: 100%;
         max-height: 400px;
         border: 1px solid #ddd;
         border-radius: 8px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.1);
     }
     
     .documento-preview .pdf-preview {
         background-color: #f8f9fa;
         border: 2px dashed #ddd;
         border-radius: 8px;
         padding: 40px 20px;
         margin: 20px 0;
     }
     
     .documento-preview .pdf-preview i {
         font-size: 3rem;
         color: #dc3545;
         margin-bottom: 15px;
     }
 </style>

 <script>
     document.addEventListener('DOMContentLoaded', function() {
         // Verificar estado del consentimiento al cargar la página si hay mascota encontrada
         {% if mascota_encontrada %}
         verificarConsentimiento({{ mascota_encontrada.id_mascota }});
         
         // Deshabilitar el botón "Seleccionar Mascota" si ya hay una mascota seleccionada
         const btnSeleccionarMascota = document.getElementById('btnSeleccionarMascota');
         if (btnSeleccionarMascota) {
             btnSeleccionarMascota.disabled = true;
             btnSeleccionarMascota.style.opacity = '0.6';
             btnSeleccionarMascota.style.cursor = 'not-allowed';
         }
         {% endif %}
     });
     
     // Variables globales
     let mascotaActual = null;
     let documentoActual = null;
     
     // Función para manejar el consentimiento
     function manejarConsentimiento(mascotaId) {
         mascotaActual = mascotaId;
         
         // Verificar si existe documento
         fetch(`/mascotas/consentimiento/ver/${mascotaId}/`)
             .then(response => response.json())
             .then(data => {
                 if (data.success) {
                     if (data.existe_documento) {
                         // Mostrar modal para ver documento
                         documentoActual = data.documento;
                         mostrarModalVerConsentimiento();
                     } else {
                         // Mostrar modal para subir documento
                         mostrarModalSubirConsentimiento();
                     }
                 } else {
                     alert('Error al verificar el consentimiento: ' + data.error);
                 }
             })
             .catch(error => {
                 console.error('Error:', error);
                 alert('Error al verificar el consentimiento');
             });
     }
     
           // Función para verificar el estado del consentimiento
      function verificarConsentimiento(mascotaId) {
          fetch(`/mascotas/consentimiento/ver/${mascotaId}/`)
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      const linkElement = document.getElementById(`consentimiento-link-${mascotaId}`);
                      
                      if (data.existe_documento) {
                          linkElement.textContent = 'Visualizar Documento';
                      } else {
                          linkElement.textContent = 'Adjuntar Documento de Consentimiento';
                      }
                  }
              })
              .catch(error => {
                  console.error('Error al verificar consentimiento:', error);
              });
      }
     
           // Función para mostrar modal de ver documento
      function mostrarModalVerConsentimiento() {
          const modal = document.getElementById('modalVerConsentimiento');
          const contenido = document.getElementById('contenidoModalVer');
          
          // Mostrar loading
          contenido.innerHTML = `
              <div style="text-align: center; padding: 20px;">
                  <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #007bff; margin-bottom: 15px;"></i>
                  <p style="color: #666; font-size: 1rem; margin: 0;">Cargando documento...</p>
              </div>
          `;
          
          modal.style.display = 'flex';
          
          // Cargar contenido del documento
          if (documentoActual) {
              const extension = documentoActual.nombre.split('.').pop().toLowerCase();
              
              if (['jpg', 'jpeg', 'png'].includes(extension)) {
                  // Mostrar imagen
                  contenido.innerHTML = `
                      <div class="documento-preview">
                          <h4 style="color: #333; margin-bottom: 15px;">${documentoActual.nombre}</h4>
                          <img src="/media/${documentoActual.url}" alt="Documento de consentimiento" style="max-width: 100%; max-height: 400px;">
                      </div>
                  `;
                             } else {
                   // Mostrar enlace para ver PDF en nueva pestaña
                   contenido.innerHTML = `
                       <div class="documento-preview">
                           <h4 style="color: #333; margin-bottom: 15px;">${documentoActual.nombre}</h4>
                           <div style="background-color: #f8f9fa; border: 2px dashed #ddd; border-radius: 8px; padding: 40px 20px; margin: 20px 0;">
                               <i class="fas fa-file-pdf" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                               <p style="color: #666; margin-bottom: 20px;">Documento PDF disponible</p>
                               <a href="/mascotas/consentimiento/ver-pdf/${documentoActual.id}/" 
                                  target="_blank" 
                                  style="background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; margin-right: 10px;">
                                   <i class="fas fa-eye"></i> Ver PDF
                               </a>
                               <a href="/mascotas/consentimiento/descargar/${documentoActual.id}/" 
                                  style="background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                                   <i class="fas fa-download"></i> Descargar
                               </a>
                           </div>
                       </div>
                   `;
              }
          }
      }
     
     // Función para mostrar modal de subir documento
     function mostrarModalSubirConsentimiento() {
         const modal = document.getElementById('modalSubirConsentimiento');
         modal.style.display = 'flex';
         
         // Limpiar formulario
         document.getElementById('formSubirConsentimiento').reset();
         document.getElementById('errorSubida').style.display = 'none';
         document.getElementById('progresoSubida').style.display = 'none';
     }
     
     // Función para subir consentimiento
     function subirConsentimiento() {
         const archivo = document.getElementById('archivoConsentimiento').files[0];
         const errorDiv = document.getElementById('errorSubida');
         const progresoDiv = document.getElementById('progresoSubida');
         
         if (!archivo) {
             errorDiv.textContent = 'Por favor seleccione un archivo';
             errorDiv.style.display = 'block';
             return;
         }
         
         // Validar tipo de archivo
         const tiposPermitidos = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
         if (!tiposPermitidos.includes(archivo.type)) {
             errorDiv.textContent = 'Tipo de archivo no permitido. Solo se aceptan PDF, JPG, JPEG y PNG';
             errorDiv.style.display = 'block';
             return;
         }
         
         // Validar tamaño (10MB)
         if (archivo.size > 10 * 1024 * 1024) {
             errorDiv.textContent = 'El archivo es demasiado grande. Máximo 10MB';
             errorDiv.style.display = 'block';
             return;
         }
         
         // Ocultar error y mostrar progreso
         errorDiv.style.display = 'none';
         progresoDiv.style.display = 'block';
         
         // Crear FormData
         const formData = new FormData();
         formData.append('documento', archivo);
         
         // Enviar archivo
         fetch(`/mascotas/consentimiento/subir/${mascotaActual}/`, {
             method: 'POST',
             body: formData
         })
         .then(response => response.json())
                   .then(data => {
              progresoDiv.style.display = 'none';
              
              if (data.success) {
                  // Cerrar modal y actualizar interfaz
                  cerrarModalSubirConsentimiento();
                  verificarConsentimiento(mascotaActual);
                  
                  // Actualizar campos del consentimiento
                  actualizarCamposConsentimiento(data);
              } else {
                  errorDiv.textContent = data.error || 'Error al subir el documento';
                  errorDiv.style.display = 'block';
              }
          })
         .catch(error => {
             progresoDiv.style.display = 'none';
             errorDiv.textContent = 'Error de conexión al subir el documento';
             errorDiv.style.display = 'block';
             console.error('Error:', error);
         });
     }
     
           // Función para actualizar campos del consentimiento
      function actualizarCamposConsentimiento(data) {
          console.log('Actualizando campos con datos:', data);
          
          // Actualizar radio button "Sí"
          const radioSi = document.querySelector(`input[name="consentimiento_{{ mascota_encontrada.id_mascota }}"][value="si"]`);
          const radioNo = document.querySelector(`input[name="consentimiento_{{ mascota_encontrada.id_mascota }}"][value="no"]`);
          
          if (radioSi && radioNo) {
              radioSi.checked = true;
              radioNo.checked = false;
          }
          
          // Método 1: Buscar campos por el texto de sus labels
          const labels = document.querySelectorAll('label');
          let clinicaInput = null;
          let fechaInput = null;
          
          console.log('Buscando labels...');
          for (let label of labels) {
              console.log('Label encontrado:', label.textContent.trim());
              if (label.textContent.trim() === 'Clínica donde firma el consentimiento') {
                  console.log('✅ Label clínica encontrado');
                  const parentDiv = label.parentElement;
                  clinicaInput = parentDiv.querySelector('input[readonly]');
              }
              if (label.textContent.trim() === 'Fecha de consentimiento') {
                  console.log('✅ Label fecha encontrado');
                  const parentDiv = label.parentElement;
                  fechaInput = parentDiv.querySelector('input[readonly]');
              }
          }
          
          // Método 2: Buscar por valor actual si no se encontraron
          if (!clinicaInput) {
              console.log('Buscando campo clínica por valor...');
              const inputs = document.querySelectorAll('input[readonly]');
              for (let input of inputs) {
                  if (input.value === 'No especificada') {
                      clinicaInput = input;
                      console.log('✅ Campo clínica encontrado por valor');
                      break;
                  }
              }
          }
          
          if (!fechaInput) {
              console.log('Buscando campo fecha por valor...');
              const inputs = document.querySelectorAll('input[readonly]');
              for (let input of inputs) {
                  if (input.value === 'No registrada') {
                      fechaInput = input;
                      console.log('✅ Campo fecha encontrado por valor');
                      break;
                  }
              }
          }
          
          console.log('Campo clínica encontrado:', clinicaInput);
          console.log('Campo fecha encontrado:', fechaInput);
          
          // Actualizar clínica de consentimiento
          if (clinicaInput && data.clinica_consentimiento) {
              clinicaInput.value = data.clinica_consentimiento;
              console.log('✅ Clínica actualizada a:', data.clinica_consentimiento);
          } else {
              console.log('❌ No se pudo actualizar clínica');
          }
          
          // Actualizar fecha de consentimiento
          if (fechaInput && data.fecha_consentimiento) {
              fechaInput.value = data.fecha_consentimiento;
              console.log('✅ Fecha actualizada a:', data.fecha_consentimiento);
          } else {
              console.log('❌ No se pudo actualizar fecha');
          }
      }
      
      // Funciones para cerrar modales
      function cerrarModalVerConsentimiento() {
          document.getElementById('modalVerConsentimiento').style.display = 'none';
      }
      
      function cerrarModalSubirConsentimiento() {
          document.getElementById('modalSubirConsentimiento').style.display = 'none';
      }
     
     // Cerrar modales al hacer clic fuera de ellos
     window.onclick = function(event) {
         const modalVer = document.getElementById('modalVerConsentimiento');
         const modalSubir = document.getElementById('modalSubirConsentimiento');
         const modalSeleccionar = document.getElementById('modalSeleccionarMascota');
         
         if (event.target === modalVer) {
             cerrarModalVerConsentimiento();
         }
         if (event.target === modalSubir) {
             cerrarModalSubirConsentimiento();
         }
         if (event.target === modalSeleccionar) {
             cerrarModalSeleccionarMascota();
         }
     }
     
     // Cerrar modales con ESC
     document.addEventListener('keydown', function(event) {
         if (event.key === 'Escape') {
             cerrarModalVerConsentimiento();
             cerrarModalSubirConsentimiento();
             cerrarModalSeleccionarMascota();
         }
     });
     
     // Función para registrar nueva atención médica
     function registrarNuevaAtencion() {
         {% if mascota_encontrada %}
             // Redirigir al formulario de atención médica con el número de chip precargado
             const nroChip = '{{ mascota_encontrada.nro_chip }}';
             window.location.href = '/atencion-medica/registrar-atencion/?nro_chip=' + encodeURIComponent(nroChip);
         {% else %}
             // Si no hay mascota encontrada, redirigir al formulario sin parámetros
             window.location.href = '/atencion-medica/registrar-atencion/';
         {% endif %}
     }
     
     // Funciones para el modal de selección de mascota
     function abrirModalSeleccionarMascota() {
         document.getElementById('modalSeleccionarMascota').style.display = 'flex';
         // Limpiar formulario y resultados
         document.getElementById('formBuscarTutor').reset();
         document.getElementById('resultadosMascotas').style.display = 'none';
         document.getElementById('mensajeError').style.display = 'none';
         document.getElementById('loadingBusqueda').style.display = 'none';
         
         // Inicializar validación de RUT
         inicializarValidacionRut('rutTutor');
     }
     
     function cerrarModalSeleccionarMascota() {
         document.getElementById('modalSeleccionarMascota').style.display = 'none';
     }
     
     function buscarMascotasPorTutor() {
         const rutTutor = document.getElementById('rutTutor').value.trim();
         
         if (!rutTutor) {
             mostrarError('Por favor ingrese el RUT del tutor');
             return;
         }
         
         // Validar formato y dígito verificador del RUT usando la librería
         console.log('Validando RUT:', rutTutor);
         if (!validarRutConLibreria(rutTutor)) {
             console.log('RUT inválido, mostrando error');
             mostrarError('RUT inválido. Verifique el número y dígito verificador.');
             return;
         }
         console.log('RUT válido, continuando con búsqueda');
         
         // Ocultar mensajes anteriores y mostrar loading
         document.getElementById('resultadosMascotas').style.display = 'none';
         document.getElementById('mensajeError').style.display = 'none';
         document.getElementById('loadingBusqueda').style.display = 'block';
         
         // Realizar búsqueda AJAX
         fetch('/mascotas/buscar-mascotas-por-tutor/', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
             },
             body: JSON.stringify({
                 rut_tutor: rutTutor
             })
         })
         .then(response => response.json())
         .then(data => {
             document.getElementById('loadingBusqueda').style.display = 'none';
             
             if (data.success) {
                 if (data.mascotas && data.mascotas.length > 0) {
                     mostrarResultadosMascotas(data.mascotas);
                 } else {
                     mostrarError('No se encontraron mascotas para este tutor');
                 }
             } else {
                 mostrarError(data.error || 'Error al buscar mascotas');
             }
         })
         .catch(error => {
             document.getElementById('loadingBusqueda').style.display = 'none';
             mostrarError('Error de conexión al buscar mascotas');
             console.error('Error:', error);
         });
     }
     

     
     function mostrarResultadosMascotas(mascotas) {
         const tbody = document.getElementById('tbodyMascotas');
         tbody.innerHTML = '';
         
         mascotas.forEach(mascota => {
             const row = document.createElement('tr');
             row.innerHTML = `
                 <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem;">${mascota.nro_chip || 'No registrado'}</td>
                 <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem;">${mascota.nombre}</td>
                 <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem;">${mascota.especie || 'No especificada'}</td>
                 <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem;">${mascota.sexo || 'No especificado'}</td>
                 <td style="padding: 10px; border-bottom: 1px solid #eee; font-size: 0.8rem;">${mascota.estado_vital || 'No especificado'}</td>
                 <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">
                     <button type="button" onclick="seleccionarMascota(${mascota.id_mascota})" class="btn btn-success" 
                             style="background-color: #28a745; border: none; padding: 6px 12px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 0.65rem; cursor: pointer;">
                         <i class="fas fa-check"></i> Seleccionar
                     </button>
                 </td>
             `;
             tbody.appendChild(row);
         });
         
         document.getElementById('resultadosMascotas').style.display = 'block';
     }
     
     function mostrarError(mensaje) {
         console.log('Mostrando error:', mensaje);
         const errorDiv = document.getElementById('mensajeError');
         errorDiv.textContent = mensaje;
         errorDiv.style.display = 'block';
         console.log('Error div display:', errorDiv.style.display);
     }
     
     function seleccionarMascota(idMascota) {
         // Cerrar el modal
         cerrarModalSeleccionarMascota();
         
         // Deshabilitar el botón "Seleccionar Mascota"
         const btnSeleccionarMascota = document.getElementById('btnSeleccionarMascota');
         if (btnSeleccionarMascota) {
             btnSeleccionarMascota.disabled = true;
             btnSeleccionarMascota.style.opacity = '0.6';
             btnSeleccionarMascota.style.cursor = 'not-allowed';
         }
         
         // Crear un formulario temporal para enviar el ID de la mascota
         const form = document.createElement('form');
         form.method = 'POST';
         form.action = '/mascotas/ficha-clinica/';
         
         // Agregar CSRF token
         const csrfToken = document.createElement('input');
         csrfToken.type = 'hidden';
         csrfToken.name = 'csrfmiddlewaretoken';
         csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
         form.appendChild(csrfToken);
         
         // Agregar el ID de la mascota
         const mascotaId = document.createElement('input');
         mascotaId.type = 'hidden';
         mascotaId.name = 'mascota_id';
         mascotaId.value = idMascota;
         form.appendChild(mascotaId);
         
         // Agregar el formulario al DOM y enviarlo
         document.body.appendChild(form);
         form.submit();
     }
     
     function realizarNuevaBusqueda() {
         // Redirigir a la página inicial del formulario para volver al estado inicial
         window.location.href = '/mascotas/ficha-clinica/';
     }
 </script>

{% endblock %}