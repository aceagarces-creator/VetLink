{% extends 'base.html' %}

{% block title %}Registrar Nueva Mascota{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}



{% block content %}
<!-- T√≠tulo principal con espacio superior reducido y en may√∫sculas -->
<h1 style="text-align: center; font-weight: bold; margin-top: 0.1rem; margin-bottom: 20px; color: #333; font-size: 1.3rem; text-transform: uppercase;">Registrar Nueva Mascota</h1>

<!-- Modal para mostrar √©xito de registro de mascota -->
{% if mensaje_exito %}
<div id="exitoModal" class="modal" style="display: flex; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
    <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 550px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; position: relative;">
            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-check-circle"></i> Mascota Registrada Exitosamente
            </h3>
        </div>
        <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 15px;"></i>
                <p style="color: #155724; font-size: 1.1rem; margin: 0;">{{ mensaje_exito }}</p>
            </div>
        </div>
        <div class="modal-footer" style="padding: 20px 25px; border-top: 1px solid #e9ecef; text-align: right; background-color: #f8f9fa; position: relative;">
            <button type="button" class="btn btn-primary" onclick="registrarAtencionMedica()" style="margin-right: 10px; background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px;">
                <i class="fas fa-stethoscope"></i> Registrar Atenci√≥n M√©dica
            </button>
            <button type="button" class="btn btn-secondary" onclick="cerrarModalExito()" style="background-color: #6c757d; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px;">
                <i class="fas fa-times"></i> Cerrar Ventana
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Formulario de b√∫squeda reorganizado horizontalmente -->
<div style="display: flex; justify-content: center; margin-bottom: 15px;">
    <form method="post" class="mb-4 buscar-tutor-form" style="display: flex; align-items: center; gap: 15px; max-width: 600px;">
        {% csrf_token %}
        <label for="{{ buscar_tutor_form.rut_tutor.id_for_label }}" style="display: block; font-weight: bold; color: #333; white-space: nowrap; font-size: 0.8rem;">
            {{ buscar_tutor_form.rut_tutor.label }}
        </label>
        <div style="position: relative;">
            {{ buscar_tutor_form.rut_tutor }}
            <!-- Contenedor para mensaje de validaci√≥n del RUT -->
            <div id="rut-validation-message" style="display: none; margin-top: 5px; padding: 8px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: 500; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
        </div>
        <button type="submit" name="buscar_tutor" class="btn btn-primary" id="btn-buscar-tutor" style="padding: 8px 16px; border-radius: 4px; background-color: #007bff; border: none; white-space: nowrap; color: #FFFFFF; font-weight: bold; font-size: 12px;">
            Buscar
        </button>
        {% if tutor_encontrado %}
        <button type="button" class="btn btn-success" id="btn-nueva-busqueda-tutor" style="padding: 8px 16px; border-radius: 4px; background-color: #28a745; border: none; white-space: nowrap; color: #FFFFFF; font-weight: bold; font-size: 12px; text-transform: none;">
            Realzar nueva b√∫squeda
        </button>
        {% endif %}
    </form>
</div>

<!-- Mensaje de error centrado bajo la l√≠nea de b√∫squeda -->
{% if buscar_tutor_form.rut_tutor.errors %}
    <div style="display: flex; justify-content: center; margin-bottom: 10px;">
        <div style="color: #dc3545; font-size: 0.65rem; text-align: center;">
            {% for error in buscar_tutor_form.rut_tutor.errors %}
                {{ error }}
            {% endfor %}
        </div>
    </div>
{% endif %}

{% if buscar_tutor_form.rut_tutor.help_text %}
    <div style="display: flex; justify-content: center; margin-bottom: 10px;">
        <div style="color: #6c757d; font-size: 0.65rem; text-align: center;">
            {{ buscar_tutor_form.rut_tutor.help_text }}
        </div>
    </div>
{% endif %}

<!-- Datos del tutor encontrado -->
{% if tutor_encontrado %}
    <!-- T√≠tulo "Antecedentes del Tutor/a" movido fuera del contenedor -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto;">ANTECEDENTES DEL TUTOR(A)</h5>
    
    <!-- Bloque "Antecedentes del Tutor/a" con ancho ajustado al 80% -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px 12px 25px;">
            <!-- Primera fila de campos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Nombres</label>
                    <input type="text" value="{{ tutor_encontrado.nombres }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Paterno</label>
                    <input type="text" value="{{ tutor_encontrado.apellido_paterno }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Materno</label>
                    <input type="text" value="{{ tutor_encontrado.apellido_materno|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
            
            <!-- Segunda fila de campos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Correo</label>
                    <input type="email" value="{{ tutor_encontrado.email|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Celular</label>
                    <input type="text" value="{{ tutor_encontrado.celular|default:'' }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
                <div>
                    <!-- Campo vac√≠o para mantener alineaci√≥n -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Secci√≥n: Registrar Mascota -->
    {% if tutor_encontrado %}
    <!-- T√≠tulo "Datos de la Mascota" movido fuera del contenedor y alineado con "Antecedentes del Tutor/a" -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto;">INGRESE LOS DATOS DE LA MASCOTA</h5>
    
    <!-- Bloque "Datos de la Mascota" con el mismo estilo visual que "Antecedentes del Tutor/a" -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px 12px 25px;">
            
            <form method="post" enctype="multipart/form-data" id="registrar_mascota_form">
                {% csrf_token %}
                <input type="hidden" name="tutor_id" value="{{ tutor_encontrado.id_tutor }}">
                
                <!-- Primera fila - Microchip, Nombre, Especie -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Microchip</label>
                        {{ registrar_mascota_form.nro_chip }}
                        {% if registrar_mascota_form.nro_chip.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.nro_chip.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.nombre.label }}</label>
                        {{ registrar_mascota_form.nombre }}
                        {% if registrar_mascota_form.nombre.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.nombre.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.especie.label }}</label>
                        {{ registrar_mascota_form.especie }}
                        {% if registrar_mascota_form.especie.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.especie.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Segunda fila - Raza, Color, Patr√≥n -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.raza.label }}</label>
                        {{ registrar_mascota_form.raza }}
                        {% if registrar_mascota_form.raza.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.raza.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.color.label }}</label>
                        {{ registrar_mascota_form.color }}
                        {% if registrar_mascota_form.color.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.color.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                                           <div>
                           <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.patron.label }}</label>
                           {{ registrar_mascota_form.patron }}
                           {% if registrar_mascota_form.patron.errors %}
                               <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                   {% for error in registrar_mascota_form.patron.errors %}{{ error }}{% endfor %}
                               </div>
                           {% endif %}
                       </div>
                </div>
                
                <!-- Tercera fila - Fecha de Nacimiento, Sexo, Estado Reproductivo -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.fecha_nacimiento.label }}</label>
                        {{ registrar_mascota_form.fecha_nacimiento }}
                        {% if registrar_mascota_form.fecha_nacimiento.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.fecha_nacimiento.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.sexo.label }}</label>
                        {{ registrar_mascota_form.sexo }}
                        {% if registrar_mascota_form.sexo.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.sexo.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.estado_reproductivo.label }}</label>
                        <div style="display: flex; align-items: center; gap: 20px; height: 42px;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="estado_reproductivo" value="True" id="estado_reproductivo_0" style="margin: 0; accent-color: #007bff; width: 16px; height: 16px;">
                                <span style="font-size: 0.65rem; color: #333;">S√≠</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <input type="radio" name="estado_reproductivo" value="False" id="estado_reproductivo_1" style="margin: 0; accent-color: #007bff; width: 16px; height: 16px;">
                                <span style="font-size: 0.65rem; color: #333;">No</span>
                            </div>
                        </div>
                        {% if registrar_mascota_form.estado_reproductivo.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.estado_reproductivo.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Cuarta fila - Modo de Obtenci√≥n, Raz√≥n de Tenencia, Vac√≠o -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.modo_obtencion.label }}</label>
                        {{ registrar_mascota_form.modo_obtencion }}
                        {% if registrar_mascota_form.modo_obtencion.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.modo_obtencion.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.razon_tenencia.label }}</label>
                        {{ registrar_mascota_form.razon_tenencia }}
                        {% if registrar_mascota_form.razon_tenencia.errors %}
                            <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                                {% for error in registrar_mascota_form.razon_tenencia.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div>
                        <!-- Columna vac√≠a para mantener alineaci√≥n -->
                    </div>
                </div>
                
                <!-- Quinta fila - Notas Adicionales (ancho completo) -->
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.notas_adicionales.label }}</label>
                    {{ registrar_mascota_form.notas_adicionales }}
                    {% if registrar_mascota_form.notas_adicionales.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.notas_adicionales.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Errores generales del formulario -->
                {% if registrar_mascota_form.non_field_errors %}
                    <div style="color: #dc3545; font-size: 0.6rem; margin-bottom: 15px; text-align: center;">
                        {% for error in registrar_mascota_form.non_field_errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
    
    <!-- T√≠tulo "AUTORIZACI√ìN PARA COMPARTIR ANTECEDENTES M√âDICOS" -->
    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto; margin-top: 20px;">AUTORIZACI√ìN PARA COMPARTIR ANTECEDENTES M√âDICOS</h5>
    
    <!-- Card de Autorizaci√≥n -->
    <div class="card mb-4" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin: 0 auto; width: 80%;">
        <div class="card-body" style="padding: 12px 25px 12px 25px;">
            <!-- Primera fila: Consentimiento, Adjuntar documento, Eliminar documento -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Registra consentimiento?</label>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="consentimiento_interoperabilidad" value="si" id="consentimiento_si" disabled style="margin: 0; accent-color: #007bff;">
                            <span style="font-size: 0.65rem; color: #333;">S√≠</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="consentimiento_interoperabilidad" value="no" id="consentimiento_no" checked disabled style="margin: 0; accent-color: #007bff;">
                            <span style="font-size: 0.65rem; color: #333;">No</span>
                        </div>
                    </div>
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Adjuntar documento</label>
                    <input type="file" name="documento_consentimiento" id="documento_consentimiento" accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; box-sizing: border-box; font-size: 0.7rem;">
                    <div style="color: #6c757d; font-size: 0.6rem; margin-top: 3px;">
                        Formatos aceptados: PDF, JPG, JPEG, PNG
                    </div>
                </div>
                <div style="display: flex; align-items: center; height: 100%;">
                    <button type="button" id="eliminar_documento" style="display: none; background-color: #e6a700; color: #FFFFFF; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; white-space: nowrap; text-decoration: none; cursor: pointer;">
                        <i class="fas fa-trash"></i> Eliminar documento
                    </button>
                </div>
            </div>
            
            <!-- Banda informativa -->
            <div style="margin-top: 15px; padding: 10px 15px; background-color: #e7f3ff; border-left: 4px solid #007bff; border-radius: 4px;">
                <p style="margin: 0; color: #0056b3; font-size: 0.65rem; font-style: italic; line-height: 1.4;">
                    <strong>Recuerde: </strong> Informar al tutor que este consentimiento autoriza compartir todos los antecedentes m√©dicos de su mascota para cualquier atenci√≥n que reciba, tanto en esta cl√≠nica como en cualquier otra que forme parte de la plataforma VetLink.
                </p>
            </div>
        </div>
    </div>
    <!-- Bot√≥n de registro -->
    <div style="text-align: center; margin-top: 2rem; margin-bottom: 2rem;">
        <button type="submit" name="registrar_mascota" style="background-color: #007bff; border: none; padding: 12px 24px; border-radius: 4px; color: white; font-weight: bold; font-size: 14px; cursor: pointer; transition: background-color 0.3s ease;">
            Registrar Mascota
        </button>
    </div>
    </form>
        </div>
    </div>
    {% endif %}
{% endif %}

<!-- Modal para mostrar informaci√≥n de chip duplicado -->
<div id="chipModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem;">
                <i class="fas fa-exclamation-triangle"></i> Chip ya registrado
            </h3>
        </div>
        <div class="modal-body">
            <div id="modalMessage"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                Entendido
            </button>
        </div>
    </div>
</div>

<style>
    /* Estilos adicionales para mejorar la apariencia */
    .container {
        font-family: Arial, sans-serif;
    }
    
    /* Estilo para el campo de entrada del formulario */
    input[type="text"], input[type="email"], select, textarea {
        border-radius: 5px;
        border: 1px solid #ddd !important;
        padding: 0px 12px !important;
        font-size: 0.65rem;
        box-sizing: border-box;
        width: 100%;
        height: 42px; /* Misma altura que los campos de Antecedentes del Tutor/a */
    }
    
    /* Estilo espec√≠fico para campos del formulario de mascota */
    .card-body input[type="text"], 
    .card-body input[type="email"], 
    .card-body select, 
    .card-body textarea {
        padding: 0px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    /* Estilos m√°s espec√≠ficos para forzar el padding reducido */
    .card-body input[type="text"] {
        padding: 0px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    .card-body input[type="email"] {
        padding: 0px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    .card-body select {
        padding: 0px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    .card-body textarea {
        padding: 5px 12px !important;
        height: 60px !important;
        min-height: 60px !important;
        border: 1px solid #ddd !important;
    }
    
    .card-body input[type="date"] {
        padding: 0px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    .card-body input[type="file"] {
        padding: 5px 12px !important;
        height: 42px !important;
        border: 1px solid #ddd !important;
    }
    
    /* Estilo para bot√≥n deshabilitado (mantiene color azul pero inactivo) */
    .btn-primary:disabled {
        background-color: #007bff !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }
    
    /* Estilo para input deshabilitado (mismo estilo que otros campos readonly) */
    input:disabled {
        background-color: #f8f9fa !important;
        color: #333 !important;
        cursor: not-allowed !important;
    }
    
    input[type="text"]:focus, input[type="email"]:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
         /* Estilos globales para radio buttons */
     input[type="radio"] {
         accent-color: #007bff !important;
         width: 16px !important;
         height: 16px !important;
         margin: 0 !important;
         cursor: pointer !important;
     }
    
    /* Estilo para campos de solo lectura */
    input[readonly] {
        background-color: #f8f9fa !important;
        color: #333 !important;
        cursor: not-allowed;
    }
    
    /* Estilos para botones */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Estilo para errores de validaci√≥n */
    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }
    
    /* Asegurar que todos los elementos usen border-box */
    * {
        box-sizing: border-box;
    }
    
    /* Estilo espec√≠fico para el input de b√∫squeda de RUT */
    .buscar-tutor-form input[type="text"]:not([readonly]) {
        max-width: 115px !important;
    }
    
    /* Estilo espec√≠fico para textarea de notas adicionales */
    textarea {
        height: 60px;
        resize: vertical;
        min-height: 60px;
    }
    
    /* Estilo para campos de fecha */
    input[type="date"] {
        height: 42px;
        padding: 0px 12px;
        font-size: 0.65rem;
        border: 1px solid #ddd !important;
    }
    
    /* Estilo para campos de archivo */
    input[type="file"] {
        height: 42px;
        padding: 5px 12px;
        font-size: 0.65rem;
        border: 1px solid #ddd !important;
        border-radius: 5px;
        background-color: #fff;
    }

/* Estilos para el modal */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 0;
    border-radius: 12px;
    width: 95%;
    max-width: 550px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    overflow: hidden;
}

@keyframes modalFadeIn {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
}

.modal-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
}

.close {
    color: white;
    font-size: 24px;
    font-weight: 300;
    cursor: pointer;
    line-height: 1;
    transition: all 0.2s ease;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
}

.close:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
}

.modal-body {
    padding: 25px;
    max-height: 70vh;
    overflow-y: auto;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    text-align: right;
    background-color: #f8f9fa;
    position: relative;
}

.modal-footer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, #dee2e6 50%, transparent 100%);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
}

/* Estilo espec√≠fico para el bot√≥n "Registrar Mascota" con efectos hover */
button[name="registrar_mascota"]:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Estilos para la informaci√≥n de la mascota */
.mascota-info {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: relative;
}

.mascota-info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
    border-radius: 8px 8px 0 0;
}

.mascota-info h4 {
    color: #495057;
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.mascota-info h4::before {
    content: 'üêæ';
    font-size: 1.2rem;
}

.mascota-info ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.mascota-info li {
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
    color: #6c757d;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.mascota-info li:last-child {
    border-bottom: none;
}

.mascota-info li strong {
    color: #495057;
    font-weight: 600;
    min-width: 80px;
}

.mascota-info li::before {
    content: '‚Ä¢';
    color: #007bff;
    font-weight: bold;
    font-size: 1.2rem;
    line-height: 1;
}

/* Mejoras para el input de chip */
.chip-input-container {
    position: relative;
}

.chip-validation-message {
    margin-top: 10px;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.chip-validation-message.success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.chip-validation-message.error {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.chip-validation-message.warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Responsive design */
@media (max-width: 768px) {
    .modal-content {
        width: 98%;
        margin: 10px;
    }
    
    .modal-header {
        padding: 15px 20px;
    }
    
    .modal-header h3 {
        font-size: 1.1rem;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 15px 20px;
    }
    
    .mascota-info {
        padding: 15px;
    }
    
    .mascota-info li {
        font-size: 0.9rem;
    }
}



/* Estilos para botones deshabilitados */
button[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Animaci√≥n para el mensaje de error del chip */
.chip-validation-message.error {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

/* Estilo para el input cuando hay error de chip */
input[name="nro_chip"].chip-error {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Estilo para el input cuando el chip es v√°lido */
input[name="nro_chip"].chip-success {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
}

/* Estilos para validaci√≥n del RUT */
.rut-validation-message {
    margin-top: 5px;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.rut-validation-message.success {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #c3e6cb;
}

.rut-validation-message.error {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border: 1px solid #f5c6cb;
    animation: shake 0.5s ease-in-out;
}

.rut-validation-message.warning {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border: 1px solid #ffeaa7;
}

/* Estilo para el input cuando hay error de RUT */
input[name="rut_tutor"].rut-error {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Estilo para el input cuando el RUT es v√°lido */
input[name="rut_tutor"].rut-success {
    border-color: #28a745 !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
}
</style>

<script>
// Todo el JavaScript consolidado en un solo event listener
document.addEventListener('DOMContentLoaded', function() {
    // Dropdown dependiente: Razas seg√∫n Especie
    const especieSelect = document.getElementById('id_especie');
    const razaSelect = document.getElementById('id_raza');
    
    if (especieSelect && razaSelect) {
        especieSelect.addEventListener('change', function() {
            const especieId = this.value;
            
            // Limpiar opciones de raza
            razaSelect.innerHTML = '<option value="">Cargando razas...</option>';
            razaSelect.disabled = true;
            
            if (especieId) {
                // Cargar razas por AJAX
                fetch('/mascotas/cargar-razas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        'especie_id': especieId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    razaSelect.innerHTML = '<option value="">Seleccione una raza</option>';
                    
                    if (data.success && data.razas) {
                        data.razas.forEach(raza => {
                            const option = document.createElement('option');
                            option.value = raza.id_raza;
                            option.textContent = raza.nombre;
                            razaSelect.appendChild(option);
                        });
                        razaSelect.disabled = false;
                        
                        // Reinicializar Select2 para el campo raza
                        if ($('#id_raza').data('select2')) {
                            $('#id_raza').select2('destroy');
                        }
                        $('#id_raza').select2({
                            theme: 'bootstrap-5',
                            placeholder: 'Seleccione una raza',
                            allowClear: true,
                            language: 'es',
                            width: '100%'
                        });
                    } else {
                        razaSelect.innerHTML = '<option value="">Error al cargar razas</option>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    razaSelect.innerHTML = '<option value="">Error al cargar razas</option>';
                });
            } else {
                razaSelect.innerHTML = '<option value="">Primero seleccione una especie</option>';
                razaSelect.disabled = false;
            }
        });
    }
    
         // Validaci√≥n espec√≠fica para el campo RUT del tutor
     const rutInput = document.querySelector('input[name="rut_tutor"]');
     const btnBuscarTutor = document.getElementById('btn-buscar-tutor');
     const rutValidationMessage = document.getElementById('rut-validation-message');
     let rutTimeoutId;
     let rutValido = false;
     
     if (rutInput) {
         rutInput.addEventListener('input', function(e) {
             let value = this.value;
             
             // Solo permitir n√∫meros, gui√≥n y K/k
             value = value.replace(/[^0-9Kk-]/g, '');
             
             // Convertir k min√∫scula a K may√∫scula
             value = value.replace(/k/g, 'K');
             
             // Asegurar que solo haya un gui√≥n
             const parts = value.split('-');
             if (parts.length > 2) {
                 value = parts[0] + '-' + parts.slice(1).join('');
             }
             
             this.value = value;
             
             // Limpiar timeout anterior
             clearTimeout(rutTimeoutId);
             
             // Limpiar mensajes anteriores
             if (rutValidationMessage) {
                 rutValidationMessage.style.display = 'none';
                 rutValidationMessage.className = 'rut-validation-message';
                 rutValidationMessage.innerHTML = '';
             }
             
             // Resetear estado de RUT v√°lido
             rutValido = false;
             habilitarBotonBuscar(false);
             
             // Solo validar si hay un valor
             if (value.length > 0) {
                 // Esperar 500ms despu√©s de que el usuario deje de escribir
                 rutTimeoutId = setTimeout(() => {
                     validarRut(value, this);
                 }, 500);
             }
         });
         
         // Prevenir pegado de caracteres no v√°lidos
         rutInput.addEventListener('paste', function(e) {
             e.preventDefault();
             let pastedText = (e.clipboardData || window.clipboardData).getData('text');
             
             // Limpiar texto pegado
             pastedText = pastedText.replace(/[^0-9Kk-]/g, '').replace(/k/g, 'K');
             
             // Insertar en la posici√≥n del cursor
             const start = this.selectionStart;
             const end = this.selectionEnd;
             const currentValue = this.value;
             
             this.value = currentValue.substring(0, start) + pastedText + currentValue.substring(end);
             this.setSelectionRange(start + pastedText.length, start + pastedText.length);
         });
     }
     
     // Funci√≥n para habilitar/deshabilitar el bot√≥n de b√∫squeda
     function habilitarBotonBuscar(habilitado) {
         if (btnBuscarTutor) {
             if (habilitado) {
                 btnBuscarTutor.disabled = false;
                 btnBuscarTutor.style.backgroundColor = '#007bff';
                 btnBuscarTutor.style.cursor = 'pointer';
                 btnBuscarTutor.title = 'Buscar tutor';
             } else {
                 btnBuscarTutor.disabled = true;
                 btnBuscarTutor.style.backgroundColor = '#6c757d';
                 btnBuscarTutor.style.cursor = 'not-allowed';
                 btnBuscarTutor.title = 'Ingrese un RUT v√°lido para buscar';
             }
         }
     }
     
     // Funci√≥n para validar RUT chileno
     function validarRut(rut, inputElement) {
         // Limpiar mensajes anteriores
         if (rutValidationMessage) {
             rutValidationMessage.style.display = 'none';
             rutValidationMessage.className = 'rut-validation-message';
         }
         
         // Validar formato b√°sico
         if (!/^\d{7,8}-[0-9K]$/.test(rut)) {
             mostrarMensajeRut('error', '‚ùå Formato de RUT inv√°lido. Use: 12345678-9', inputElement);
             return;
         }
         
         // Extraer n√∫mero y d√≠gito verificador
         const numero = rut.split('-')[0];
         const dv = rut.split('-')[1];
         
         // Calcular d√≠gito verificador
         let suma = 0;
         let multiplicador = 2;
         
         for (let i = numero.length - 1; i >= 0; i--) {
             suma += parseInt(numero[i]) * multiplicador;
             multiplicador = multiplicador === 7 ? 2 : multiplicador + 1;
         }
         
         let dvCalculado = 11 - (suma % 11);
         if (dvCalculado === 11) {
             dvCalculado = '0';
         } else if (dvCalculado === 10) {
             dvCalculado = 'K';
         } else {
             dvCalculado = dvCalculado.toString();
         }
         
         // Validar d√≠gito verificador
         if (dv.toUpperCase() === dvCalculado) {
             mostrarMensajeRut('success', '‚úÖ RUT v√°lido', inputElement);
             rutValido = true;
             habilitarBotonBuscar(true);
         } else {
             mostrarMensajeRut('error', '‚ùå D√≠gito verificador incorrecto', inputElement);
             rutValido = false;
             habilitarBotonBuscar(false);
         }
     }
     
     // Funci√≥n para mostrar mensaje de validaci√≥n del RUT
     function mostrarMensajeRut(tipo, mensaje, inputElement) {
         if (rutValidationMessage) {
             rutValidationMessage.className = `rut-validation-message ${tipo}`;
             rutValidationMessage.innerHTML = mensaje;
             
             // Solo mostrar si hay un mensaje
             if (mensaje && mensaje.trim().length > 0) {
                 rutValidationMessage.style.display = 'flex';
             } else {
                 rutValidationMessage.style.display = 'none';
             }
             
             // Aplicar estilos al input
             inputElement.classList.remove('rut-error', 'rut-success');
             if (tipo === 'error') {
                 inputElement.classList.add('rut-error');
             } else if (tipo === 'success') {
                 inputElement.classList.add('rut-success');
             }
         }
     }
     
     // Prevenir env√≠o del formulario si el RUT no es v√°lido
     const buscarTutorForm = document.querySelector('.buscar-tutor-form');
     if (buscarTutorForm) {
         buscarTutorForm.addEventListener('submit', function(e) {
             if (!rutValido && rutInput && rutInput.value.trim().length > 0) {
                 e.preventDefault();
                 alert('Por favor, ingrese un RUT v√°lido antes de buscar.');
                 return false;
             }
         });
     }
     
     // Inicializar bot√≥n de b√∫squeda como deshabilitado
     habilitarBotonBuscar(false);
    
    // Aplicar estilos espec√≠ficos a los campos del formulario de mascota
    const mascotaFormControls = document.querySelectorAll('.card-body input, .card-body select, .card-body textarea');
    mascotaFormControls.forEach(control => {
        if (!control.hasAttribute('readonly')) {
            control.style.setProperty('width', '100%', 'important');
            control.style.setProperty('padding', '0px 12px', 'important');
            control.style.setProperty('border', '1px solid #ddd', 'important');
            control.style.setProperty('border-radius', '4px', 'important');
            control.style.setProperty('font-size', '0.65rem', 'important');
            control.style.setProperty('height', '42px', 'important');
            control.style.setProperty('box-sizing', 'border-box', 'important');
        }
    });
    
    // Estilo espec√≠fico para textarea en el formulario de mascota
    const mascotaTextareas = document.querySelectorAll('.card-body textarea');
    mascotaTextareas.forEach(textarea => {
        textarea.style.setProperty('height', '60px', 'important');
        textarea.style.setProperty('min-height', '60px', 'important');
        textarea.style.setProperty('resize', 'vertical', 'important');
        textarea.style.setProperty('padding', '5px 12px', 'important');
        textarea.style.setProperty('border', '1px solid #ddd', 'important');
    });
    
    // Estilo espec√≠fico para campos de archivo en el formulario de mascota
    const mascotaFileInputs = document.querySelectorAll('.card-body input[type="file"]');
    mascotaFileInputs.forEach(fileInput => {
        fileInput.style.setProperty('height', '42px', 'important');
        fileInput.style.setProperty('padding', '5px 12px', 'important');
        fileInput.style.setProperty('font-size', '0.65rem', 'important');
        fileInput.style.setProperty('border', '1px solid #ddd', 'important');
        fileInput.style.setProperty('border-radius', '4px', 'important');
        fileInput.style.setProperty('background-color', '#fff', 'important');
    });
    
    // Estilo espec√≠fico para campos de fecha en el formulario de mascota
    const mascotaDateInputs = document.querySelectorAll('.card-body input[type="date"]');
    mascotaDateInputs.forEach(dateInput => {
        dateInput.style.setProperty('height', '42px', 'important');
        dateInput.style.setProperty('padding', '0px 12px', 'important');
        dateInput.style.setProperty('font-size', '0.65rem', 'important');
        dateInput.style.setProperty('border', '1px solid #ddd', 'important');
    });
    
    // Estilo espec√≠fico para selects en el formulario de mascota (excluyendo Select2)
    const mascotaSelects = document.querySelectorAll('.card-body select:not(.select2-enabled)');
    mascotaSelects.forEach(select => {
        select.style.setProperty('height', '42px', 'important');
        select.style.setProperty('padding', '0px 12px', 'important');
        select.style.setProperty('font-size', '0.65rem', 'important');
        select.style.setProperty('border', '1px solid #ddd', 'important');
    });
    
    // Aplicar estilos generales a otros campos (como el de b√∫squeda de RUT)
    const generalFormControls = document.querySelectorAll('input, select, textarea');
    generalFormControls.forEach(control => {
        if (!control.hasAttribute('readonly') && !control.closest('.card-body')) {
            control.style.width = '100%';
            control.style.padding = '10px 12px';
            control.style.border = '1px solid #ddd';
            control.style.borderRadius = '4px';
            control.style.fontSize = '0.65rem';
            control.style.height = '42px';
            control.style.boxSizing = 'border-box';
        }
    });
    
    // Validaci√≥n en tiempo real del n√∫mero de chip
    const chipInput = document.querySelector('input[name="nro_chip"]');
    const mascotaForm = document.querySelector('form[enctype="multipart/form-data"]');
    const registrarButton = document.querySelector('button[name="registrar_mascota"]');
    let timeoutId;
    let chipDuplicado = false; // Variable para rastrear si el chip est√° duplicado
    
    if (chipInput) {
        chipInput.addEventListener('input', function() {
            const chipValue = this.value.trim();
            
            // Limpiar timeout anterior
            clearTimeout(timeoutId);
            
            // Limpiar mensajes anteriores
            const existingMessage = this.parentNode.querySelector('.chip-validation-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Resetear estado de chip duplicado
            chipDuplicado = false;
            habilitarBotonRegistro(true); // Habilitar bot√≥n por defecto
            
            // Solo validar si hay un valor
            if (chipValue.length > 0) {
                // Esperar 500ms despu√©s de que el usuario deje de escribir
                timeoutId = setTimeout(() => {
                    validarChip(chipValue, this);
                }, 500);
            }
        });
    }
    
    // Funci√≥n para habilitar/deshabilitar el bot√≥n de registro
    function habilitarBotonRegistro(habilitado) {
        if (registrarButton) {
            if (habilitado) {
                registrarButton.disabled = false;
                registrarButton.style.backgroundColor = '#007bff';
                registrarButton.style.cursor = 'pointer';
                registrarButton.title = 'Registrar nueva mascota';
            } else {
                registrarButton.disabled = true;
                registrarButton.style.backgroundColor = '#007bff';
                registrarButton.style.cursor = 'not-allowed';
                registrarButton.title = 'No se puede registrar: Chip duplicado';
            }
        }
    }
    
    // Prevenir env√≠o del formulario si hay chip duplicado
    if (mascotaForm) {
        mascotaForm.addEventListener('submit', function(e) {
            if (chipDuplicado) {
                e.preventDefault();
                alert('No se puede registrar la mascota. El n√∫mero de chip ya existe en el sistema.');
                return false;
            }
        });
    }
    
    function validarChip(nroChip, inputElement) {
        fetch('/mascotas/validar-chip/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                'nro_chip': nroChip
            })
        })
        .then(response => response.json())
        .then(data => {
            // Limpiar mensajes anteriores
            const existingMessage = inputElement.parentNode.querySelector('.chip-validation-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Crear elemento de mensaje
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chip-validation-message';
            
            if (data.success) {
                // Chip disponible
                messageDiv.className = 'chip-validation-message success';
                messageDiv.innerHTML = '‚úÖ ' + data.mensaje;
                inputElement.style.borderColor = '#28a745';
                inputElement.classList.remove('chip-error');
                inputElement.classList.add('chip-success');
                chipDuplicado = false; // Resetear estado
                habilitarBotonRegistro(true); // Habilitar bot√≥n
            } else if (data.chip_existe) {
                // Chip ya existe - mostrar modal y bloquear formulario
                messageDiv.className = 'chip-validation-message error';
                messageDiv.innerHTML = '‚ùå ' + data.mensaje;
                inputElement.style.borderColor = '#dc3545';
                inputElement.classList.remove('chip-success');
                inputElement.classList.add('chip-error');
                chipDuplicado = true; // Marcar como duplicado
                habilitarBotonRegistro(false); // Deshabilitar bot√≥n
                
                // Mostrar modal con informaci√≥n detallada
                mostrarModalChipDuplicado(data);
            } else {
                // Error en la validaci√≥n
                messageDiv.className = 'chip-validation-message warning';
                messageDiv.innerHTML = '‚ö†Ô∏è ' + (data.error || 'Error al validar el chip');
                inputElement.style.borderColor = '#ffc107';
                inputElement.classList.remove('chip-success', 'chip-error');
                chipDuplicado = false; // Resetear estado
                habilitarBotonRegistro(true); // Habilitar bot√≥n
            }
            
            // Insertar el mensaje despu√©s del input
            inputElement.parentNode.appendChild(messageDiv);
        })
        .catch(error => {
            console.error('Error al validar chip:', error);
            chipDuplicado = false; // Resetear estado en caso de error
            habilitarBotonRegistro(true); // Habilitar bot√≥n
        });
    }
    
    function mostrarModalChipDuplicado(data) {
        const modal = document.getElementById('chipModal');
        const modalMessage = document.getElementById('modalMessage');
        
        // Construir el contenido del modal
        let modalContent = `
            <div style="margin-bottom: 15px;">
                <p style="color: #721c24; font-weight: 600; margin: 0 0 15px 0;">
                    ‚ùå Ya existe una mascota registrada en el sistema asociada al n√∫mero de chip: <strong>${data.nro_chip || 'N/A'}</strong>
                </p>
            </div>
        `;
        
        if (data.mascota_info) {
            modalContent += `
                <div class="mascota-info">
                    <h4>Mascota Existente</h4>
                    <ul>
                        <li><strong>Nombre:</strong> ${data.mascota_info.nombre}</li>
                        <li><strong>Tutor:</strong> ${data.mascota_info.tutor}</li>
                        <li><strong>Especie:</strong> ${data.mascota_info.especie}</li>
                        <li><strong>Raza:</strong> ${data.mascota_info.raza}</li>
                    </ul>
                </div>
            `;
        }
        
        modalMessage.innerHTML = modalContent;
        
        // Mostrar el modal
        modal.style.display = 'flex';
        
        // Ocultar el bot√≥n X para que solo se pueda cerrar con "Entendido"
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
            closeBtn.style.display = 'none';
        }
    }
    
    // Funci√≥n para cerrar el modal
    window.closeModal = function() {
        const modal = document.getElementById('chipModal');
        modal.style.display = 'none';
    }

    // Funci√≥n para registrar atencion medica (por ahora sin funcionalidad)
    window.registrarAtencionMedica = function() {
        // Por ahora no tiene funcionalidad
        alert('Funcionalidad de Registrar Atenci√≥n M√©dica ser√° implementada pr√≥ximamente.');
    }

    // Funci√≥n para cerrar el modal de √©xito
    window.cerrarModalExito = function() {
        const exitoModal = document.getElementById('exitoModal');
        if (exitoModal) {
            exitoModal.style.display = 'none';
        }
    }
    
         // Funcionalidad para deshabilitar formulario de b√∫squeda de tutor cuando ya hay un tutor encontrado
     const inputRutTutor = document.getElementById('{{ buscar_tutor_form.rut_tutor.id_for_label }}');
     const btnNuevaBusquedaTutor = document.getElementById('btn-nueva-busqueda-tutor');
     
     // Si hay un tutor encontrado, deshabilitar solo el input y el bot√≥n Buscar
     {% if tutor_encontrado %}
     if (inputRutTutor && btnBuscarTutor) {
         inputRutTutor.disabled = true;
         btnBuscarTutor.disabled = true;
         btnBuscarTutor.style.backgroundColor = '#6c757d';
         btnBuscarTutor.style.cursor = 'not-allowed';
     }
     {% endif %}
    
    // Evento para el bot√≥n "Realizar una nueva b√∫squeda"
    if (btnNuevaBusquedaTutor) {
        btnNuevaBusquedaTutor.addEventListener('click', function() {
            // Redirigir a la p√°gina inicial del formulario
            window.location.href = '/mascotas/registrar/';
        });
    }
    
    // Funcionalidad para el documento de consentimiento
    const documentoConsentimiento = document.getElementById('documento_consentimiento');
    const consentimientoSi = document.getElementById('consentimiento_si');
    const consentimientoNo = document.getElementById('consentimiento_no');
    const eliminarDocumento = document.getElementById('eliminar_documento');
    
         if (documentoConsentimiento) {
         documentoConsentimiento.addEventListener('change', function() {
             if (this.files && this.files[0]) {
                 // Se ha seleccionado un archivo
                 consentimientoSi.checked = true;
                 consentimientoNo.checked = false;
                 consentimientoSi.disabled = true;
                 consentimientoNo.disabled = true;
                 eliminarDocumento.style.display = 'inline-block';
             } else {
                 // No hay archivo seleccionado
                 consentimientoSi.checked = false;
                 consentimientoNo.checked = true;
                 consentimientoSi.disabled = true;
                 consentimientoNo.disabled = true;
                 eliminarDocumento.style.display = 'none';
             }
         });
     }
    
    if (eliminarDocumento) {
        eliminarDocumento.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Limpiar el input de archivo
            if (documentoConsentimiento) {
                documentoConsentimiento.value = '';
            }
            
            // Resetear radio buttons
            consentimientoSi.checked = false;
            consentimientoNo.checked = true;
            consentimientoSi.disabled = true;
            consentimientoNo.disabled = true;
            
            // Ocultar enlace de eliminar
            this.style.display = 'none';
        });
    }
});
</script>
{% endblock %}