{% extends 'base.html' %}

{% block content %}
<div style="padding: 0; margin: 0;">
    <h1 style="text-align: center; font-weight: bold; margin-top: 0.1rem; margin-bottom: 20px; color: #333; font-size: 1.3rem; text-transform: uppercase;">Registrar Nueva Mascota</h1>
    
    <!-- Mensajes de éxito -->
    {% if mensaje_exito %}
    <div class="alert alert-success" style="background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 0 auto 20px auto; width: 80%; text-align: center;">
        {{ mensaje_exito }}
    </div>
    {% endif %}
    
    <!-- Sección: Buscar Tutor -->
    <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); padding: 1.5rem 2rem; margin: 0 auto 1.5rem auto; width: 80%;">
        <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; text-align: left;">Datos del Tutor</h5>
        
        <!-- Formulario de búsqueda de tutor -->
        <form method="post" style="margin-bottom: 20px;">
            {% csrf_token %}
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                <label for="{{ buscar_tutor_form.rut_tutor.id_for_label }}" style="font-weight: bold; color: #666; font-size: 0.65rem; white-space: nowrap;">{{ buscar_tutor_form.rut_tutor.label }}</label>
                {{ buscar_tutor_form.rut_tutor }}
                <button type="submit" name="buscar_tutor" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; font-size: 12px; white-space: nowrap;">Buscar</button>
            </div>
            
            {% if buscar_tutor_form.rut_tutor.errors %}
                <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px; text-align: center;">
                    {% for error in buscar_tutor_form.rut_tutor.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
            
            {% if buscar_tutor_form.rut_tutor.help_text %}
                <div style="color: #6c757d; font-size: 0.6rem; margin-top: 3px; text-align: center;">
                    {{ buscar_tutor_form.rut_tutor.help_text }}
                </div>
            {% endif %}
        </form>
        
        <!-- Datos del tutor encontrado -->
        {% if tutor_encontrado %}
        <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">RUT</label>
                    <input type="text" value="{{ tutor_encontrado.nro_documento }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Nombres</label>
                    <input type="text" value="{{ tutor_encontrado.nombres }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Paterno</label>
                    <input type="text" value="{{ tutor_encontrado.apellido_paterno }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Apellido Materno</label>
                    <input type="text" value="{{ tutor_encontrado.apellido_materno }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Correo Electrónico</label>
                    <input type="text" value="{{ tutor_encontrado.email }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Celular</label>
                    <input type="text" value="{{ tutor_encontrado.celular }}" readonly style="width: 100%; padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.65rem; background-color: #e9ecef;">
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Sección: Registrar Mascota -->
    {% if tutor_encontrado %}
    <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); padding: 1.5rem 2rem; margin: 0 auto; width: 80%;">
        <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; text-align: left;">Datos de la Mascota</h5>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="tutor_id" value="{{ tutor_encontrado.id_tutor }}">
            
            <!-- Primera fila - Nombre, Especie, Raza -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.nombre.label }}</label>
                    {{ registrar_mascota_form.nombre }}
                    {% if registrar_mascota_form.nombre.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.nombre.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.especie.label }}</label>
                    {{ registrar_mascota_form.especie }}
                    {% if registrar_mascota_form.especie.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.especie.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.raza.label }}</label>
                    {{ registrar_mascota_form.raza }}
                    {% if registrar_mascota_form.raza.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.raza.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Segunda fila - Color, Número de Chip, Sexo -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.color.label }}</label>
                    {{ registrar_mascota_form.color }}
                    {% if registrar_mascota_form.color.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.color.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.nro_chip.label }}</label>
                    {{ registrar_mascota_form.nro_chip }}
                    {% if registrar_mascota_form.nro_chip.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.nro_chip.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.sexo.label }}</label>
                    {{ registrar_mascota_form.sexo }}
                    {% if registrar_mascota_form.sexo.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.sexo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tercera fila - Fecha de Nacimiento, Estado Reproductivo -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.fecha_nacimiento.label }}</label>
                    {{ registrar_mascota_form.fecha_nacimiento }}
                    {% if registrar_mascota_form.fecha_nacimiento.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.fecha_nacimiento.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.estado_reproductivo.label }}</label>
                    {{ registrar_mascota_form.estado_reproductivo }}
                    {% if registrar_mascota_form.estado_reproductivo.errors %}
                        <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                            {% for error in registrar_mascota_form.estado_reproductivo.errors %}{{ error }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div>
                    <!-- Columna vacía para mantener la grilla -->
                </div>
            </div>
            
            <!-- Cuarta fila - Notas Adicionales -->
            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.notas_adicionales.label }}</label>
                {{ registrar_mascota_form.notas_adicionales }}
                {% if registrar_mascota_form.notas_adicionales.errors %}
                    <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                        {% for error in registrar_mascota_form.notas_adicionales.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Quinta fila - Documento de Consentimiento -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">{{ registrar_mascota_form.documento_consentimiento.label }}</label>
                {{ registrar_mascota_form.documento_consentimiento }}
                {% if registrar_mascota_form.documento_consentimiento.errors %}
                    <div style="color: #dc3545; font-size: 0.6rem; margin-top: 3px;">
                        {% for error in registrar_mascota_form.documento_consentimiento.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
                <div style="color: #6c757d; font-size: 0.6rem; margin-top: 3px;">
                    Formatos aceptados: PDF, JPG, JPEG, PNG
                </div>
            </div>
            
            <!-- Errores generales del formulario -->
            {% if registrar_mascota_form.non_field_errors %}
                <div style="color: #dc3545; font-size: 0.6rem; margin-bottom: 15px; text-align: center;">
                    {% for error in registrar_mascota_form.non_field_errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
            
            <!-- Botón de registro -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <button type="submit" name="registrar_mascota" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; font-size: 12px;">
                    Registrar Mascota
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<script>
// Dropdown dependiente: Razas según Especie
document.addEventListener('DOMContentLoaded', function() {
    const especieSelect = document.getElementById('id_especie');
    const razaSelect = document.getElementById('id_raza');
    
    if (especieSelect && razaSelect) {
        especieSelect.addEventListener('change', function() {
            const especieId = this.value;
            
            // Limpiar opciones de raza
            razaSelect.innerHTML = '<option value="">Cargando razas...</option>';
            razaSelect.disabled = true;
            
            if (especieId) {
                // Cargar razas por AJAX
                fetch('/mascotas/cargar-razas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        'especie_id': especieId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    razaSelect.innerHTML = '<option value="">Seleccione una raza</option>';
                    
                    if (data.success && data.razas) {
                        data.razas.forEach(raza => {
                            const option = document.createElement('option');
                            option.value = raza.id_raza;
                            option.textContent = raza.nombre;
                            razaSelect.appendChild(option);
                        });
                        razaSelect.disabled = false;
                    } else {
                        razaSelect.innerHTML = '<option value="">Error al cargar razas</option>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    razaSelect.innerHTML = '<option value="">Error al cargar razas</option>';
                });
            } else {
                razaSelect.innerHTML = '<option value="">Primero seleccione una especie</option>';
                razaSelect.disabled = false;
            }
        });
    }
});

// Aplicar estilos a los campos del formulario
document.addEventListener('DOMContentLoaded', function() {
    // Aplicar estilos a todos los inputs, selects y textareas
    const formControls = document.querySelectorAll('input, select, textarea');
    formControls.forEach(control => {
        if (!control.hasAttribute('readonly')) {
            control.style.width = '100%';
            control.style.padding = '6px 10px';
            control.style.border = '1px solid #ced4da';
            control.style.borderRadius = '4px';
            control.style.fontSize = '0.65rem';
        }
    });
});
</script>
{% endblock %}