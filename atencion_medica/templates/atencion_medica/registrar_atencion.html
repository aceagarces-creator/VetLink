{% extends 'base.html' %}

{% block title %}Registrar Atención Médica{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <!-- Título principal con espacio superior reducido y en mayúsculas -->
    <h1 style="text-align: center; font-weight: bold; margin-top: 0.1rem; margin-bottom: 20px; color: #333; font-size: 1.3rem; text-transform: uppercase;">REGISTRAR ATENCIÓN MÉDICA</h1>

    {% if mensaje_exito %}
    <div style="background-color: #d4edda; color: #155724; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
        {{ mensaje_exito }}
    </div>
    {% endif %}

    {% if mensaje_error %}
    <div style="background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
        {{ mensaje_error }}
    </div>
    {% endif %}

    <!-- Mensajes de Django -->
    {% if messages %}
        {% for message in messages %}
            <div style="background-color: {% if message.tags == 'success' %}#d4edda; color: #155724; border: 1px solid #c3e6cb;{% elif message.tags == 'error' %}#f8d7da; color: #721c24; border: 1px solid #f5c6cb;{% else %}#d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %} padding: 12px; border-radius: 4px; margin-bottom: 20px;">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}" style="margin-right: 8px;"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- SECCIÓN DE BÚSQUEDA DE MASCOTA -->
    <div style="width: 80%; margin: 0 auto; display: flex; justify-content: flex-end; margin-bottom: 30px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button type="button" class="btn btn-primary" id="btn-seleccionar-mascota" style="padding: 8px 16px; border-radius: 4px; background-color: #007bff; border: none; white-space: nowrap; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                <i class="fas fa-search"></i> Seleccionar Mascota
            </button>
            {% if mascota_encontrada %}
            <button type="button" class="btn btn-success" id="btn-nueva-busqueda" style="padding: 8px 16px; border-radius: 4px; background-color: #28a745; border: none; white-space: nowrap; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                Realizar Nueva Búsqueda
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Modal para seleccionar mascota -->
    <div id="modalSeleccionarMascota" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
        <!-- CSRF token para el modal -->
        {% csrf_token %}
        <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; padding: 20px 25px; display: flex; justify-content: center; align-items: center; position: relative;">
                <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-paw"></i> Seleccionar Mascota
                </h3>
            </div>
            <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                <div style="margin-bottom: 20px;">
                    <form id="formBuscarTutor" style="display: flex; align-items: end;">
                        <div style="margin-right: 10px;">
                            <label style="display: block; font-weight: bold; color: #333; font-size: 0.9rem; margin-bottom: 8px;">Ingrese el Rut del Tutor(a):</label>
                                                            <input type="text" id="rutTutor" name="rut_tutor" placeholder="Ej: 12345678-9" required 
                                       style="width: 200px; padding: 10px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; box-sizing: border-box;"
                                       oninput="formatearRutInput(this)" onblur="validarRutCampo(this)" 
                                       onkeypress="return /[0-9kK-]/i.test(event.key) || event.key === 'Backspace' || event.key === 'Delete' || event.key === 'Tab'">
                        </div>
                        <div>
                            <button type="button" onclick="buscarMascotasPorTutorAtencion()" class="btn btn-primary" 
                                    style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Mensaje de error para RUT -->
                <div id="errorRut" style="display: none; color: #dc3545; font-size: 0.8rem; margin-top: 5px; padding: 8px 12px; border-radius: 4px; background-color: #f8d7da; border: 1px solid #f5c6cb;"></div>
                
                <!-- Tabla de mascotas -->
                <div id="tablaMascotas" style="display: none;">
                    <h5 style="color: #333; margin-bottom: 15px; font-size: 0.9rem;">Mascotas del Tutor</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; width: 100%;">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Microchip</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Nombre</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Especie</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Sexo</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: left;">Estado</th>
                                    <th style="padding: 8px; border-bottom: 1px solid #ddd; font-size: 0.8rem; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyMascotas">
                                <!-- Las mascotas se cargarán dinámicamente aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Mensaje cuando no hay mascotas -->
                <div id="mensajeNoMascotas" style="display: none; text-align: center; padding: 20px; color: #666;">
                    <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px; color: #007bff;"></i>
                    <p>No se encontraron mascotas para este tutor.</p>
                </div>
                
                <!-- Botón Cerrar -->
                <div style="text-align: right; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                    <button type="button" onclick="cerrarModalSeleccionarMascota()" style="background-color: #6c757d; border: none; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; font-size: 12px; cursor: pointer;">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN DE DATOS DE LA MASCOTA ENCONTRADA -->
    {% if mascota_encontrada %}
        <!-- Formulario principal para registrar atención médica -->
        <form method="post" id="form-atencion-medica" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            
            <!-- Campo oculto para el número de chip -->
            <input type="hidden" name="nro_chip_busqueda" value="{{ mascota_encontrada.nro_chip }}">
            
            <!-- Título "REGISTRO DE ATENCIÓN MÉDICA" movido fuera del contenedor -->
            <h5 style="color: #333; margin-bottom: 15px; font-size: 0.8rem; width: 80%; margin-left: auto; margin-right: auto;">REGISTRO DE ATENCIÓN MÉDICA</h5>
     
            <div class="paciente-info" style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 20px;">
           
                                                                           <!-- PRIMERA FILA: Clínica (columna 1) + Médico tratante (columna 2) + Fecha de atención (columna 3) -->
                                      <div class="grid-3">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Clínica</label>
                    <input type="text" value="Clínica 1" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                    <input type="hidden" name="id_clinica" value="1">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Médico tratante</label>
                    <input type="text" value="{{ medico_tratante.nombres }} {{ medico_tratante.apellido_paterno }} {{ medico_tratante.apellido_materno }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                    <input type="hidden" name="id_personal" value="{{ medico_tratante.id_personal }}">
                </div>
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Fecha de Atención</label>
                    <input type="text" id="fecha_display" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                    <input type="hidden" name="fecha_atencion" id="fecha_hidden">
                </div>
            </div>
            
                                                  <!-- SEGUNDA FILA: Rut Tutor y Tutor(a) -->
             <div class="grid-3" style="margin-top: 10px;">
                <div>
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Rut Tutor(a)</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.nro_documento }}" readonly
                           style="width: 100%; max-width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>

                <!-- Tutor(a) alineado con Especie y extendido hasta donde termina Raza -->
                <div style="grid-column: 2 / 4;">
                    <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Tutor(a)</label>
                    <input type="text" value="{{ mascota_encontrada.id_tutor.nombres }} {{ mascota_encontrada.id_tutor.apellido_paterno }}" readonly
                           style="width: 100%; max-width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                </div>
            </div>
             
             <!-- TERCERA FILA: Mascota, Especie, Raza -->
             <div class="grid-3" style="margin-top: 10px;">
                 <div>
                     <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Mascota</label>
                     <input type="text" value="{{ mascota_encontrada.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                 </div>
                 <div>
                     <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Especie</label>
                     <input type="text" value="{{ mascota_encontrada.id_especie.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                 </div>
                 <div>
                     <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Raza</label>
                     <input type="text" value="{{ mascota_encontrada.id_raza.nombre }}" readonly style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                 </div>
             </div>
            
                        
             
                                                                                                         <div class="grid-3" style="margin-top: 10px;">
                    <!-- Tercera fila: Servicio, Detalle servicio, Peso y Temperatura -->
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Servicio (*)</label>
                        <select name="id_servicio" id="id_servicio" style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                            <option value="">Seleccione servicio</option>
                            {% for servicio in servicios %}
                                <option value="{{ servicio.id_servicio }}">{{ servicio.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Detalle Servicio (*)</label>
                        <select name="id_servicio_detalle" id="id_servicio_detalle" style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                            <option value="">Seleccione un servicio primero</option>
                        </select>
                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div>
                         <div style="display: flex; gap: 10px;">
                             <div style="flex: 1;">
                                 <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Peso (kg)</label>
                                 <input type="number" name="peso" step="0.1" min="0" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                             </div>
                             <div style="flex: 1;">
                                 <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Temperatura (°C)</label>
                                 <input type="number" name="temperatura" step="0.1" min="0" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem;">
                             </div>
                         </div>
                     </div>
                </div>
              
                                                        
               
                              <div class="grid-3" style="margin-top: 10px;">
                    <!-- Quinta fila: Motivo consulta (3 columnas) -->
                    <div style="grid-column: 1 / -1;">
                        <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Motivo Consulta (*)</label>
                        <textarea name="detalle_atencion" rows="4" style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                    </div>
                </div>
               
               <div class="grid-3" style="margin-top: 10px;">
                   <!-- Sexta fila: Diagnóstico (3 columnas) -->
                   <div style="grid-column: 1 / -1;">
                       <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Diagnóstico</label>
                       <textarea name="diagnostico" rows="4" style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                   </div>
               </div>
               
               <div class="grid-3" style="margin-top: 10px;">
                   <!-- Séptima fila: Tratamiento (3 columnas) -->
                   <div style="grid-column: 1 / -1;">
                       <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 5px;">Tratamiento</label>
                       <textarea name="tratamiento" rows="4" style="width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; color: #333; box-sizing: border-box; font-size: 0.65rem; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                   </div>
               </div>

               <!-- TABLA DE DOCUMENTOS ADJUNTOS -->
               <div class="grid-3" style="margin-top: 20px;">
                   <div style="grid-column: 1 / -1;">
                       <label style="display: block; font-weight: bold; color: #666; font-size: 0.65rem; margin-bottom: 10px;">Documentos Adjuntos</label>
                       
                       <!-- Tabla de documentos -->
                       <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                           <table id="documentos-table" style="width: 100%; border-collapse: collapse; background-color: #fff;">
                                                               <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-weight: bold; color: #666; font-size: 0.65rem; width: 25%;">Documento</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-weight: bold; color: #666; font-size: 0.65rem; width: 25%;">Tipo de Documento</th>
                                        <th style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd; font-weight: bold; color: #666; font-size: 0.65rem; width: 35%;">Nombre del Documento</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd; font-weight: bold; color: #666; font-size: 0.65rem; width: 15%;">Acción</th>
                                    </tr>
                                </thead>
                               <tbody id="documentos-tbody">
                                                                       <!-- Fila inicial -->
                                    <tr class="documento-row" data-row-id="0">
                                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                                            <input type="file" name="documento_0" accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.65rem;">
                                            <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
                                        </td>
                                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                                                                                         <select name="tipo_documento_0" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; font-size: 0.65rem;">
                                                 <option value="">Seleccione tipo</option>
                                                 <option value="Certificado Médico">Certificado Médico</option>
                                                 <option value="Examen Médico">Examen Médico</option>
                                                 <option value="Receta Médica">Receta Médica</option>
                                                 <option value="Formulario de Consentimiento">Formulario de Consentimiento</option>
                                                 <option value="Otros">Otros</option>
                                             </select>
                                            <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
                                        </td>
                                        <td style="padding: 8px; border-bottom: 1px solid #eee;">
                                            <input type="text" name="nombre_documento_0" placeholder="Nombre del documento" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; font-size: 0.65rem;">
                                            <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
                                        </td>
                                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                                            <button type="button" class="btn-eliminar-documento" style="padding: 4px 8px; border-radius: 3px; background-color: #dc3545; border: none; color: #FFFFFF; font-weight: bold; font-size: 10px; cursor: pointer;" title="Eliminar documento">
                                                ✕
                                            </button>
                                        </td>
                                    </tr>
                               </tbody>
                           </table>
                       </div>
                       
                       <!-- Botón para agregar documento -->
                       <div style="margin-top: 10px; text-align: center;">
                           <button type="button" id="btn-agregar-documento" style="padding: 8px 16px; border-radius: 4px; background-color: #28a745; border: none; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                               Agregar Documento
                           </button>
                       </div>
                       
                       <!-- Mensaje de límite alcanzado -->
                       <div id="mensaje-limite" style="color: #dc3545; font-size: 0.65rem; text-align: center; margin-top: 5px; display: none;">
                           Máximo 5 documentos permitidos
                                               </div>
                                    </div>
             </div>
           
             </div>
             
                           <!-- Botón Registrar Atención -->
              <div style="text-align: center; margin-top: 30px;">
                  <button type="submit" name="registrar_atencion" id="btn-registrar-atencion" class="btn btn-primary" style="background-color: #007bff; border: none; padding: 8px 16px; border-radius: 4px; text-decoration: none; color: #FFFFFF; font-weight: bold; font-size: 12px; cursor: pointer;">
                      Registrar Atención
                  </button>
              </div>
         </form>
         
         <!-- Modal para errores de validación -->
         <div id="modal-errores" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center;">
             <div class="modal-content" style="background-color: #fefefe; margin: auto; padding: 0; border-radius: 12px; width: 95%; max-width: 550px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); overflow: hidden;">
                 <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; position: relative;">
                     <h3 style="margin: 0; color: #ffffff; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                         <i class="fas fa-exclamation-triangle"></i> Campos Obligatorios Requeridos
                     </h3>
                     <span class="close-modal" style="color: white; font-size: 24px; font-weight: 300; cursor: pointer; line-height: 1; transition: all 0.2s ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(255,255,255,0.1);">&times;</span>
                 </div>
                 <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);">
                     <div style="text-align: center; padding: 20px;">
                         <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #dc3545; margin-bottom: 15px;"></i>
                         <p style="color: #721c24; font-size: 1.1rem; margin: 0 0 20px 0;">Por favor, complete los siguientes campos obligatorios:</p>
                         <ul id="lista-errores" style="margin: 0; padding-left: 20px; color: #721c24; font-size: 0.9rem; text-align: left; display: inline-block;">
                             <!-- Los errores se insertarán aquí dinámicamente -->
                         </ul>
                     </div>
                     <p style="margin: 20px 0 0 0; color: #666; font-size: 0.8rem; font-style: italic; text-align: center;">Los campos obligatorios están marcados con (*)</p>
                 </div>
                 <div class="modal-footer" style="padding: 20px 25px; border-top: 1px solid #e9ecef; text-align: right; background-color: #f8f9fa; position: relative;">
                     <button type="button" class="btn-cerrar-modal" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);">
                         <i class="fas fa-times"></i> Cerrar
                     </button>
                 </div>
             </div>
         </div>
                               
             
              
     {% endif %}
 </div>

<script>
// Funcionalidad para el buscador de mascota y documentos adjuntos
document.addEventListener('DOMContentLoaded', function() {
    const chipInput = document.querySelector('input[name="nro_chip"]');
    const btnBuscar = document.getElementById('btn-buscar');
    const btnNuevaBusqueda = document.getElementById('btn-nueva-busqueda');
    
    // Validación para que el campo de microchip solo acepte números
    if (chipInput) {
        chipInput.addEventListener('input', function(e) {
            // Remover cualquier carácter que no sea número
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        // Prevenir pegar texto que contenga caracteres no numéricos
        chipInput.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            const numericOnly = pastedText.replace(/[^0-9]/g, '');
            this.value = numericOnly;
        });
        
        // Prevenir arrastrar y soltar texto que contenga caracteres no numéricos
        chipInput.addEventListener('drop', function(e) {
            e.preventDefault();
            const droppedText = e.dataTransfer.getData('text');
            const numericOnly = droppedText.replace(/[^0-9]/g, '');
            this.value = numericOnly;
        });
    }
    
    // Si hay una mascota encontrada, deshabilitar solo el input y el botón Buscar
    {% if mascota_encontrada %}
    if (chipInput && btnBuscar) {
        chipInput.disabled = true;
        btnBuscar.disabled = true;
    }
    {% endif %}
    
         // Evento para el botón "Realizar nueva búsqueda"
     if (btnNuevaBusqueda) {
         btnNuevaBusqueda.addEventListener('click', function() {
             // Redirigir a la página inicial del formulario sin parámetros
             window.location.href = '/atencion-medica/registrar/';
         });
     }
     
     // Eventos para cerrar modal
     const modal = document.getElementById('modal-errores');
     const closeBtn = document.querySelector('.close-modal');
     const cerrarBtn = document.querySelector('.btn-cerrar-modal');
     
     // Cerrar con el botón X
     if (closeBtn) {
         closeBtn.addEventListener('click', cerrarModal);
     }
     
     // Cerrar con el botón "Cerrar"
     if (cerrarBtn) {
         cerrarBtn.addEventListener('click', cerrarModal);
     }
     
     // Cerrar haciendo clic fuera del modal
     if (modal) {
         modal.addEventListener('click', function(e) {
             if (e.target === modal) {
                 cerrarModal();
             }
         });
     }
     
     // Cerrar con la tecla Escape
     document.addEventListener('keydown', function(e) {
         if (e.key === 'Escape' && modal && modal.style.display === 'block') {
             cerrarModal();
         }
     });
     
     // Prevenir tooltips de validación HTML5 nativa
     document.addEventListener('invalid', function(e) {
         e.preventDefault();
     }, true);
     
     // Prevenir tooltips de validación en campos específicos
     const camposDocumentos = document.querySelectorAll('.documento-row input, .documento-row select');
     camposDocumentos.forEach(campo => {
         campo.addEventListener('invalid', function(e) {
             e.preventDefault();
         });
     });
     
     // Deshabilitar validación HTML5 nativa en campos de documentos
     function deshabilitarValidacionNativa() {
         const camposDoc = document.querySelectorAll('.documento-row input, .documento-row select');
         camposDoc.forEach(campo => {
             campo.removeAttribute('required');
             campo.removeAttribute('pattern');
             campo.removeAttribute('minlength');
             campo.removeAttribute('maxlength');
         });
     }
     
     // Ejecutar al cargar la página
     deshabilitarValidacionNativa();
     

     
         // Ocultar campos de documentos si no hay archivo seleccionado
     const fileInputs = document.querySelectorAll('input[type="file"]');
     const tipoSelects = document.querySelectorAll('select[name^="tipo_documento"]');
     
     fileInputs.forEach((input, index) => {
         input.addEventListener('change', function() {
             const tipoSelect = tipoSelects[index];
             if (this.files.length > 0) {
                 tipoSelect.style.backgroundColor = '#fff';
             } else {
                 tipoSelect.style.backgroundColor = '#f8f9fa';
             }
         });
     });
     
     // Establecer fecha actual en el campo de fecha
     const fechaDisplay = document.getElementById('fecha_display');
     const fechaHidden = document.getElementById('fecha_hidden');
     if (fechaDisplay && fechaHidden) {
         const today = new Date();
         const formattedDate = today.toISOString().split('T')[0]; // Formato YYYY-MM-DD
         fechaHidden.value = formattedDate;
         fechaDisplay.value = today.toLocaleDateString('es-ES'); // Formato DD/MM/YYYY para mostrar
     }
     
     // Función para cargar servicios detalle cuando se selecciona un servicio
     const servicioSelect = document.getElementById('id_servicio');
     const detalleSelect = document.getElementById('id_servicio_detalle');
     
     if (servicioSelect && detalleSelect) {
         servicioSelect.addEventListener('change', function() {
             const servicioId = this.value;
             
             // Limpiar el dropdown de detalle
             detalleSelect.innerHTML = '<option value="">Cargando...</option>';
             
             if (servicioId) {
                 // Obtener el token CSRF
                 const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                 
                 // Hacer petición AJAX para obtener servicios detalle
                 fetch('/atencion-medica/cargar-servicios-detalle/', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                         'X-CSRFToken': csrfToken
                     },
                     body: JSON.stringify({
                         servicio_id: servicioId
                     })
                 })
                 .then(response => response.json())
                 .then(data => {
                     if (data.success) {
                         // Limpiar y llenar el dropdown
                         detalleSelect.innerHTML = '<option value="">Seleccione un detalle</option>';
                         data.servicios_detalle.forEach(servicio => {
                             const option = document.createElement('option');
                             option.value = servicio.id_servicio_detalle;
                             option.textContent = servicio.nombre;
                             detalleSelect.appendChild(option);
                         });
                     } else {
                         detalleSelect.innerHTML = '<option value="">Error al cargar detalles</option>';
                         console.error('Error:', data.error);
                     }
                 })
                 .catch(error => {
                     detalleSelect.innerHTML = '<option value="">Error al cargar detalles</option>';
                     console.error('Error:', error);
                 });
             } else {
                 detalleSelect.innerHTML = '<option value="">Seleccione un servicio primero</option>';
             }
         });
     }

     // FUNCIONALIDAD PARA TABLA DE DOCUMENTOS ADJUNTOS
     let documentoCount = 1; // Ya tenemos 1 fila inicial
     const maxDocumentos = 5;
     const btnAgregarDocumento = document.getElementById('btn-agregar-documento');
     const tbody = document.getElementById('documentos-tbody');
     const mensajeLimite = document.getElementById('mensaje-limite');

     // Función para agregar nueva fila de documento
     function agregarFilaDocumento() {
         if (documentoCount >= maxDocumentos) {
             return;
         }

                   const newRow = document.createElement('tr');
          newRow.className = 'documento-row';
          newRow.setAttribute('data-row-id', documentoCount);
          newRow.innerHTML = `
              <td style="padding: 8px; border-bottom: 1px solid #eee;">
                  <input type="file" name="documento_${documentoCount}" accept=".pdf,.jpg,.jpeg,.png" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.65rem;">
                  <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">
                  <select name="tipo_documento_${documentoCount}" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; font-size: 0.65rem;">
                      <option value="">Seleccione tipo</option>
                      <option value="Certificado Médico">Certificado Médico</option>
                      <option value="Examen Médico">Examen Médico</option>
                      <option value="Receta Médica">Receta Médica</option>
                      <option value="Formulario de Consentimiento">Formulario de Consentimiento</option>
                      <option value="Otros">Otros</option>
                  </select>
                  <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">
                  <input type="text" name="nombre_documento_${documentoCount}" placeholder="Nombre del documento" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #f8f9fa; color: #333; font-size: 0.65rem;">
                  <div class="error-message" style="color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: none;"></div>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center;">
                  <button type="button" class="btn-eliminar-documento" style="padding: 4px 8px; border-radius: 3px; background-color: #dc3545; border: none; color: #FFFFFF; font-weight: bold; font-size: 10px; cursor: pointer;" title="Eliminar documento">
                      ✕
                  </button>
              </td>
          `;

         tbody.appendChild(newRow);
         documentoCount++;

         // Configurar eventos para la nueva fila
         configurarEventosFila(newRow);

         // Verificar si alcanzamos el límite
         if (documentoCount >= maxDocumentos) {
             btnAgregarDocumento.style.display = 'none';
             mensajeLimite.style.display = 'block';
         }
     }

     // Función para configurar eventos de una fila
     function configurarEventosFila(row) {
         const fileInput = row.querySelector('input[type="file"]');
         const tipoSelect = row.querySelector('select');
         const nombreInput = row.querySelector('input[type="text"]');

         // Evento para cambio de archivo
         fileInput.addEventListener('change', function() {
             if (this.files.length > 0) {
                 // Validar tipo de archivo
                 const file = this.files[0];
                 const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                 
                 if (!allowedTypes.includes(file.type)) {
                     mostrarErrorCampo(this, 'Solo se permiten archivos PDF, JPG, JPEG y PNG');
                     this.value = '';
                     return;
                 }

                 // Validar tamaño (máximo 5MB)
                 if (file.size > 5 * 1024 * 1024) {
                     mostrarErrorCampo(this, 'El archivo no puede superar 5MB');
                     this.value = '';
                     return;
                 }

                 // Cambiar color de fondo de campos relacionados
                 tipoSelect.style.backgroundColor = '#fff';
                 nombreInput.style.backgroundColor = '#fff';
                 
                 limpiarErrorCampo(this);
                 limpiarErrorCampo(tipoSelect);
                 limpiarErrorCampo(nombreInput);
             } else {
                 // Restaurar estado inicial
                 tipoSelect.style.backgroundColor = '#f8f9fa';
                 nombreInput.style.backgroundColor = '#f8f9fa';
                 
                 limpiarErrorCampo(this);
                 limpiarErrorCampo(tipoSelect);
                 limpiarErrorCampo(nombreInput);
             }
         });

         // Evento para cambio de tipo de documento
         tipoSelect.addEventListener('change', function() {
             if (fileInput.files.length > 0 && !this.value) {
                 mostrarErrorCampo(this, 'Tipo de documento es obligatorio cuando hay un archivo');
             } else {
                 limpiarErrorCampo(this);
             }
         });

                    // Evento para cambio de nombre de documento
           nombreInput.addEventListener('input', function() {
               if (fileInput.files.length > 0 && !this.value.trim()) {
                   mostrarErrorCampo(this, 'Nombre del documento es obligatorio cuando hay un archivo');
               } else {
                   limpiarErrorCampo(this);
               }
           });

          // Evento para el botón eliminar
          const btnEliminar = row.querySelector('.btn-eliminar-documento');
          if (btnEliminar) {
              btnEliminar.addEventListener('click', function() {
                  eliminarFilaDocumento(row);
              });
          }
      }

      // Función para eliminar fila de documento
      function eliminarFilaDocumento(row) {
          row.remove();
          documentoCount--;
          
          // Reordenar los nombres de los campos para mantener secuencia
          reordenarNombresCampos();
          
          // Verificar si debemos mostrar el botón de agregar
          if (documentoCount < maxDocumentos) {
              btnAgregarDocumento.style.display = 'inline-block';
              mensajeLimite.style.display = 'none';
          }
      }

      // Función para reordenar los nombres de los campos después de eliminar una fila
      function reordenarNombresCampos() {
          const filas = document.querySelectorAll('.documento-row');
          filas.forEach((fila, index) => {
              const fileInput = fila.querySelector('input[type="file"]');
              const tipoSelect = fila.querySelector('select');
              const nombreInput = fila.querySelector('input[type="text"]');
              
              // Actualizar nombres de los campos
              fileInput.name = `documento_${index}`;
              tipoSelect.name = `tipo_documento_${index}`;
              nombreInput.name = `nombre_documento_${index}`;
              
              // Actualizar data-row-id
              fila.setAttribute('data-row-id', index);
          });
      }

      // Configurar eventos para la fila inicial
      const filaInicial = document.querySelector('.documento-row');
      if (filaInicial) {
          configurarEventosFila(filaInicial);
          
          // Agregar evento para el botón eliminar de la fila inicial
          const btnEliminar = filaInicial.querySelector('.btn-eliminar-documento');
          if (btnEliminar) {
              btnEliminar.addEventListener('click', function() {
                  // Solo permitir eliminar si hay más de una fila
                  if (documentoCount > 1) {
                      eliminarFilaDocumento(filaInicial);
                  } else {
                      // Si es la única fila, solo limpiar los campos
                      const fileInput = filaInicial.querySelector('input[type="file"]');
                      const tipoSelect = filaInicial.querySelector('select');
                      const nombreInput = filaInicial.querySelector('input[type="text"]');
                      
                      fileInput.value = '';
                      tipoSelect.value = '';
                      nombreInput.value = '';
                      tipoSelect.style.backgroundColor = '#f8f9fa';
                      nombreInput.style.backgroundColor = '#f8f9fa';
                      
                      limpiarErrorCampo(fileInput);
                      limpiarErrorCampo(tipoSelect);
                      limpiarErrorCampo(nombreInput);
                  }
              });
          }
      }

     // Evento para el botón agregar documento
     if (btnAgregarDocumento) {
         btnAgregarDocumento.addEventListener('click', agregarFilaDocumento);
     }

           // Validación antes de enviar el formulario de atención médica
      const formAtencion = document.getElementById('form-atencion-medica');
      if (formAtencion) {
          formAtencion.addEventListener('submit', function(e) {
              e.preventDefault(); // Prevenir envío inmediato
              
              // Limpiar errores previos
              limpiarTodosLosErrores();
              
              let hayErrores = false;
              let camposConError = [];
              
              // Validar Servicio
              const servicioSelect = document.getElementById('id_servicio');
              if (!servicioSelect || !servicioSelect.value) {
                  if (servicioSelect) mostrarErrorCampo(servicioSelect, 'El servicio es obligatorio');
                  hayErrores = true;
                  camposConError.push('Servicio');
              }
              
              // Validar Detalle Servicio
              const detalleSelect = document.getElementById('id_servicio_detalle');
              if (!detalleSelect || !detalleSelect.value) {
                  if (detalleSelect) mostrarErrorCampo(detalleSelect, 'El detalle de servicio es obligatorio');
                  hayErrores = true;
                  camposConError.push('Detalle Servicio');
              }
              
              // Validar Motivo Consulta
              const motivoTextarea = document.querySelector('textarea[name="detalle_atencion"]');
              if (!motivoTextarea || !motivoTextarea.value.trim()) {
                  if (motivoTextarea) mostrarErrorCampo(motivoTextarea, 'El motivo de consulta es obligatorio');
                  hayErrores = true;
                  camposConError.push('Motivo Consulta');
              } else if (motivoTextarea.value.trim().length < 30) {
                  mostrarErrorCampo(motivoTextarea, 'El motivo de consulta debe tener al menos 30 caracteres');
                  hayErrores = true;
                  camposConError.push('Motivo Consulta');
              }
              
              // Validar documentos adjuntos
              const filas = document.querySelectorAll('.documento-row');
              let hayErroresDocumentos = false;
              filas.forEach(fila => {
                  const fileInput = fila.querySelector('input[type="file"]');
                  const tipoSelect = fila.querySelector('select');
                  const nombreInput = fila.querySelector('input[type="text"]');

                  if (fileInput && fileInput.files.length > 0) {
                      if (!tipoSelect.value) {
                          mostrarErrorCampo(tipoSelect, 'Tipo de documento es obligatorio');
                          hayErrores = true;
                          hayErroresDocumentos = true;
                      }
                      if (!nombreInput.value.trim()) {
                          mostrarErrorCampo(nombreInput, 'Nombre del documento es obligatorio');
                          hayErrores = true;
                          hayErroresDocumentos = true;
                      }
                  }
              });
              
              // Agregar línea de documentos adjuntos si hay errores en documentos
              if (hayErroresDocumentos) {
                  camposConError.push('Información complementaria documentos adjuntos');
              }
              
                             if (hayErrores) {
                   // Mostrar modal con los campos faltantes
                   mostrarModalErrores(camposConError);
                   
                   // Hacer scroll hacia el primer campo con error
                   const primerError = document.querySelector('.campo-error[style*="display: block"]');
                   if (primerError) {
                       primerError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                   }
               } else {
                   // Si no hay errores, enviar el formulario
                   // Crear un campo oculto para registrar_atencion si no existe
                   let registrarField = document.querySelector('input[name="registrar_atencion"]');
                   if (!registrarField) {
                       registrarField = document.createElement('input');
                       registrarField.type = 'hidden';
                       registrarField.name = 'registrar_atencion';
                       registrarField.value = '';
                       this.appendChild(registrarField);
                   }
                   this.submit();
               }
          });
      }
      
      // Función para limpiar todos los errores
      function limpiarTodosLosErrores() {
          // Limpiar errores de campos principales
          const camposPrincipales = document.querySelectorAll('#id_servicio, #id_servicio_detalle, textarea[name="detalle_atencion"]');
          camposPrincipales.forEach(campo => {
              limpiarErrorCampo(campo);
          });
          
          // Limpiar errores de documentos
          const camposDocumentos = document.querySelectorAll('.documento-row input, .documento-row select');
          camposDocumentos.forEach(campo => {
              limpiarErrorCampo(campo);
          });
      }
      
      // Función para mostrar error en campos del formulario principal
      function mostrarErrorCampo(element, message) {
          element.style.borderColor = '#dc3545';
          element.style.boxShadow = '0 0 0 2px rgba(220, 53, 69, 0.25)';
          
          // Buscar mensaje de error existente (puede ser .campo-error o .error-message)
          let errorDiv = element.parentNode.querySelector('.campo-error') || element.parentNode.querySelector('.error-message');
          if (!errorDiv) {
              errorDiv = document.createElement('div');
              errorDiv.className = 'campo-error';
              errorDiv.style.cssText = 'color: #dc3545; font-size: 0.6rem; margin-top: 2px; display: block;';
              element.parentNode.appendChild(errorDiv);
          }
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
      }
      
             // Función para limpiar error en campos del formulario principal
       function limpiarErrorCampo(element) {
           element.style.borderColor = '#ccc';
           element.style.boxShadow = 'none';
           
           // Buscar y ocultar mensaje de error (puede ser .campo-error o .error-message)
           const errorDiv = element.parentNode.querySelector('.campo-error') || element.parentNode.querySelector('.error-message');
           if (errorDiv) {
               errorDiv.style.display = 'none';
           }
       }
       
       // Función para mostrar modal de errores
       function mostrarModalErrores(camposConError) {
           const modal = document.getElementById('modal-errores');
           const listaErrores = document.getElementById('lista-errores');
           
           // Limpiar lista anterior
           listaErrores.innerHTML = '';
           
           // Agregar cada campo con error a la lista
           camposConError.forEach(campo => {
               const li = document.createElement('li');
               li.textContent = campo;
               li.style.marginBottom = '5px';
               listaErrores.appendChild(li);
           });
           
           // Mostrar modal
           modal.style.display = 'flex'; // Usar flex para centrar contenido
       }
       
       // Función para cerrar modal
       function cerrarModal() {
           const modal = document.getElementById('modal-errores');
           modal.style.display = 'none';
       }
       
       
});
</script>

<style>
    /* Variables CSS para grid consistente */
    :root{
      --grid-gap: 20px;   /* mismo gap actual */
      --col-w: 1fr;       /* usar fracciones para que se ajuste al espacio disponible */
    }

    .grid-3 { display:grid; grid-template-columns: repeat(3, var(--col-w)); gap: var(--grid-gap); }

    /* Anchos calculados de cada tarjeta para que las columnas tengan exactamente el mismo ancho */
    .paciente-info, .registro-info { width: 80%; margin: 0 auto; }

    /* Que nada limite el ancho interno en estas tarjetas */
    .paciente-info input[type="text"],
    .registro-info input[type="text"],
    .registro-info select,
    .registro-info input[type="date"] {
      max-width: 100% !important;
    }

    /* Estilos adicionales para mejorar la apariencia */
    .container {
        font-family: Arial, sans-serif;
    }
    
         /* Estilo para el campo de entrada del formulario */
     input[type="text"]:not([readonly]), input[type="email"] {
         border-radius: 5px;
         border: 1px solid #ddd;
         padding: 8px 12px;
         font-size: 12px;
         box-sizing: border-box;
         max-width: 175px; /* Tamaño normal para campos del formulario */
     }
     
     /* Estilo para campos de solo lectura (sin límite de ancho) */
     input[type="text"][readonly], input[type="email"][readonly] {
         border-radius: 5px;
         border: 1px solid #ddd;
         padding: 8px 12px;
         font-size: 12px;
         box-sizing: border-box;
         max-width: 100%; /* Sin límite para campos readonly */
     }
    
    input[type="text"]:focus, input[type="email"]:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    /* Estilo para campos de solo lectura */
    input[readonly] {
        background-color: #f8f9fa !important;
        color: #333 !important;
        cursor: not-allowed;
    }
    
    /* Estilos para botones */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Estilo para botón deshabilitado (mantiene color azul pero inactivo) */
    .btn-primary:disabled {
        background-color: #007bff !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }
    
    /* Estilo para input deshabilitado (mismo estilo que otros campos readonly) */
    input:disabled {
        background-color: #f8f9fa !important;
        color: #333 !important;
        cursor: not-allowed !important;
    }
    
         /* Asegurar que todos los elementos usen border-box */
     * {
         box-sizing: border-box;
     }
     
     /* Estilos específicos para la tabla de documentos adjuntos */
     #documentos-table {
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
     }
     
     #documentos-table th {
         background-color: #f8f9fa !important;
         border-bottom: 2px solid #dee2e6 !important;
     }
     
     #documentos-table td {
         vertical-align: top;
     }
     
     #documentos-table input[type="file"] {
         border: 1px solid #ccc;
         border-radius: 4px;
         padding: 5px;
         font-size: 0.65rem;
         background-color: #fff;
     }
     
     #documentos-table input[type="file"]:focus {
         outline: none;
         border-color: #007bff;
         box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
     }
     
     #documentos-table select {
         border: 1px solid #ccc;
         border-radius: 4px;
         padding: 8px;
         font-size: 0.65rem;
         background-color: #f8f9fa;
         color: #333;
     }
     
     #documentos-table select:focus {
         outline: none;
         border-color: #007bff;
         box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
         background-color: #fff;
     }
     
     #documentos-table input[type="text"] {
         border: 1px solid #ccc;
         border-radius: 4px;
         padding: 8px;
         font-size: 0.65rem;
         background-color: #f8f9fa;
         color: #333;
     }
     
     #documentos-table input[type="text"]:focus {
         outline: none;
         border-color: #007bff;
         box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
         background-color: #fff;
     }
     
     #btn-agregar-documento {
         transition: all 0.3s ease;
     }
     
     #btn-agregar-documento:hover {
         background-color: #218838 !important;
         transform: translateY(-1px);
         box-shadow: 0 2px 4px rgba(0,0,0,0.2);
     }
     
     #btn-agregar-documento:disabled {
         background-color: #6c757d !important;
         cursor: not-allowed !important;
         opacity: 0.6 !important;
     }
     
     .error-message {
         color: #dc3545;
         font-size: 0.6rem;
         margin-top: 2px;
         display: none;
     }
     
           .documento-row:hover {
          background-color: #f8f9fa;
      }
      
      /* Estilos para el botón eliminar documento */
      .btn-eliminar-documento {
          transition: all 0.3s ease;
      }
      
      .btn-eliminar-documento:hover {
          background-color: #c82333 !important;
          transform: scale(1.1);
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
             .btn-eliminar-documento:active {
           transform: scale(0.95);
       }
       
       /* Estilos para el botón Registrar Atención */
       #btn-registrar-atencion {
           transition: all 0.3s ease;
       }
       
       #btn-registrar-atencion:hover {
           background-color: #0056b3 !important;
           transform: translateY(-1px);
           box-shadow: 0 2px 4px rgba(0,0,0,0.2);
       }
       
       #btn-registrar-atencion:active {
           transform: translateY(0);
           box-shadow: 0 1px 2px rgba(0,0,0,0.1);
       }
       
               #btn-registrar-atencion:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Estilos para campos con error */
        .campo-error {
            color: #dc3545;
            font-size: 0.6rem;
            margin-top: 2px;
            display: none;
        }
        
                 /* Estilos para campos con error en el formulario principal */
         select.error, textarea.error {
             border-color: #dc3545 !important;
             box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important;
         }
         
         /* Estilos para el modal */
         .modal {
             animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
         }
         
         .modal-content {
             animation: modalFadeIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
         }
         
         @keyframes modalFadeIn {
             from {
                 opacity: 0;
                 transform: translateY(-30px) scale(0.9);
             }
             to {
                 opacity: 1;
                 transform: translateY(0) scale(1);
             }
         }
         
         .close-modal:hover {
             background: rgba(255,255,255,0.2) !important;
             transform: scale(1.1);
         }
         
         .btn-cerrar-modal:hover {
             background: linear-gradient(135deg, #5a6268 0%, #495057 100%) !important;
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4) !important;
         }

          /* Deshabilitar tooltips de validación HTML5 nativa */
          input:invalid,
          select:invalid,
          textarea:invalid {
              box-shadow: none !important;
          }
          
          /* Ocultar tooltips de validación nativa */
          input::-webkit-validation-bubble-message,
          select::-webkit-validation-bubble-message,
          textarea::-webkit-validation-bubble-message {
              display: none !important;
              opacity: 0 !important;
              visibility: hidden !important;
          }
          
          /* Para Firefox */
          input:-moz-ui-invalid,
          select:-moz-ui-invalid,
          textarea:-moz-ui-invalid {
              box-shadow: none !important;
          }
          
          /* Para IE/Edge */
          input:invalid,
          select:invalid,
          textarea:invalid {
              -ms-box-shadow: none !important;
          }
          
          /* Deshabilitar tooltips de validación en todos los navegadores */
          input::-webkit-validation-bubble-message,
          select::-webkit-validation-bubble-message,
          textarea::-webkit-validation-bubble-message {
              display: none !important;
              opacity: 0 !important;
              visibility: hidden !important;
          }
          
          /* Para Firefox */
          input:-moz-ui-invalid,
          select:-moz-ui-invalid,
          textarea:-moz-ui-invalid {
              box-shadow: none !important;
          }
          
          /* Para Safari */
          input:invalid,
          select:invalid,
          textarea:invalid {
              -webkit-appearance: none;
              -moz-appearance: none;
              appearance: none;
          }

   </style>

    <script>
        // Funciones para el modal de selección de mascota
        function abrirModalSeleccionarMascota() {
            const modal = document.getElementById('modalSeleccionarMascota');
            if (modal) {
                modal.style.display = 'flex';
                const rutInput = document.getElementById('rutTutor');
                if (rutInput) {
                    // Inicializar validación específica para este modal
                    inicializarValidacionRutModal(rutInput);
                    // Limpiar el campo al abrir el modal
                    rutInput.value = '';
                    ocultarErrorRut();
                }
            }
        }

                        function cerrarModalSeleccionarMascota() {
                    const modal = document.getElementById('modalSeleccionarMascota');
                    const rutInput = document.getElementById('rutTutor');
                    const errorDiv = document.getElementById('errorRut');
                    const tablaMascotas = document.getElementById('tablaMascotas');
                    const mensajeNoMascotas = document.getElementById('mensajeNoMascotas');
                    
                    if (modal) modal.style.display = 'none';
                    if (rutInput) {
                        rutInput.value = '';
                        ocultarErrorRut();
                    }
                    if (errorDiv) errorDiv.style.display = 'none';
                    if (tablaMascotas) tablaMascotas.style.display = 'none';
                    if (mensajeNoMascotas) mensajeNoMascotas.style.display = 'none';
                }

        // Funciones específicas para manejo de errores en este modal
        function mostrarErrorRut(mensaje) {
            const errorDiv = document.getElementById('errorRut');
            if (errorDiv) {
                errorDiv.textContent = mensaje;
                errorDiv.style.display = 'block';
            }
        }

        function ocultarErrorRut() {
            const errorDiv = document.getElementById('errorRut');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }

        // Función específica para inicializar validación de RUT en este modal
        function inicializarValidacionRutModal(input) {
            if (!input) {
                console.error('Elemento de RUT no proporcionado');
                return;
            }
            
            // Agregar evento para formateo automático
            input.addEventListener('input', function() {
                formatearRutInput(this);
            });
            
            // Agregar evento para validación al perder el foco
            input.addEventListener('blur', function() {
                const rut = this.value.trim();
                if (rut && !validarRutConLibreria(rut)) {
                    mostrarErrorRut('RUT inválido. Verifique el número y dígito verificador.');
                } else {
                    ocultarErrorRut();
                }
            });
        }

        function buscarMascotasPorTutorAtencion() {
            const rutInput = document.getElementById('rutTutor');
            
            if (!rutInput) {
                console.error('Elemento rutTutor no encontrado');
                return;
            }
            
            const rut = rutInput.value.trim();
            
            if (!rut) {
                mostrarErrorRut('Por favor ingrese el RUT del tutor');
                return;
            }
            
            if (!validarRutConLibreria(rut)) {
                mostrarErrorRut('RUT inválido. Verifique el número y dígito verificador.');
                return;
            }
            
            // Ocultar mensaje de error si el RUT es válido
            ocultarErrorRut();
            
            // Mostrar indicador de carga
            const tablaMascotas = document.getElementById('tablaMascotas');
            const mensajeNoMascotas = document.getElementById('mensajeNoMascotas');
            
            tablaMascotas.style.display = 'none';
            mensajeNoMascotas.style.display = 'none';
            
            // Obtener CSRF token
            const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfTokenElement) {
                console.error('CSRF token no encontrado');
                mostrarErrorRut('Error de seguridad: token CSRF no encontrado');
                return;
            }
            
            // Realizar petición AJAX
            fetch('/mascotas/buscar-mascotas-por-tutor/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfTokenElement.value
                },
                body: JSON.stringify({
                    rut_tutor: rut
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarMascotas(data.mascotas);
                } else {
                    mostrarErrorRut(data.error || 'Error al buscar mascotas');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarErrorRut('Error de conexión al buscar mascotas');
            });
        }

        function mostrarMascotas(mascotas) {
            const tbody = document.getElementById('tbodyMascotas');
            const tablaMascotas = document.getElementById('tablaMascotas');
            const mensajeNoMascotas = document.getElementById('mensajeNoMascotas');
            
            tbody.innerHTML = '';
            
            if (mascotas && mascotas.length > 0) {
                mascotas.forEach(mascota => {
                    const row = document.createElement('tr');
                    row.style.cssText = 'border-bottom: 1px solid #eee;';
                    
                    row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">${mascota.nro_chip || 'No registrado'}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">${mascota.nombre}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">${mascota.especie}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">${mascota.sexo}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; font-size: 0.65rem;">${mascota.estado_vital}</td>
                                                        <td style="padding: 8px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle;">
                                    <button type="button" onclick="seleccionarMascota(${mascota.id_mascota})" class="btn btn-success" 
                                            style="background-color: #28a745; border: none; padding: 6px 12px; border-radius: 4px; color: #FFFFFF; font-weight: bold; font-size: 11px; cursor: pointer;">
                                        Seleccionar
                                    </button>
                                </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                tablaMascotas.style.display = 'block';
                mensajeNoMascotas.style.display = 'none';
            } else {
                tablaMascotas.style.display = 'none';
                mensajeNoMascotas.style.display = 'block';
            }
        }

        function seleccionarMascota(idMascota) {
            // Cerrar modal
            cerrarModalSeleccionarMascota();
            
            // Crear formulario temporal para enviar el ID de la mascota
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = window.location.href;
            
            // Agregar CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Agregar campo oculto con el ID de la mascota
            const mascotaInput = document.createElement('input');
            mascotaInput.type = 'hidden';
            mascotaInput.name = 'mascota_id';
            mascotaInput.value = idMascota;
            form.appendChild(mascotaInput);
            
            // Enviar formulario
            document.body.appendChild(form);
            form.submit();
        }

        function realizarNuevaBusqueda() {
            // Redirigir a la página sin parámetros
            window.location.href = '/atencion-medica/registrar/';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Botón para abrir modal
            const btnSeleccionarMascota = document.getElementById('btn-seleccionar-mascota');
            if (btnSeleccionarMascota) {
                btnSeleccionarMascota.addEventListener('click', abrirModalSeleccionarMascota);
            }
            
            // Botón para nueva búsqueda
            const btnNuevaBusqueda = document.getElementById('btn-nueva-busqueda');
            if (btnNuevaBusqueda) {
                btnNuevaBusqueda.addEventListener('click', realizarNuevaBusqueda);
            }
            
            // Deshabilitar botón "Seleccionar Mascota" si ya hay una mascota seleccionada
            if (document.querySelector('.paciente-info')) {
                btnSeleccionarMascota.disabled = true;
                btnSeleccionarMascota.style.opacity = '0.6';
                btnSeleccionarMascota.style.cursor = 'not-allowed';
            }
        });

        // Cerrar modal al hacer clic fuera de él
        window.onclick = function(event) {
            const modal = document.getElementById('modalSeleccionarMascota');
            if (event.target === modal) {
                cerrarModalSeleccionarMascota();
            }
        }
    </script>
    
    <!-- Forzar recarga de caché -->
    <script>
        // Limpiar caché del navegador para este archivo
        if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_RELOAD) {
            console.log('Página recargada - caché limpiado');
        }
    </script>
{% endblock %}
